//> This file is part of Ymacs, an Emacs-like editor for the Web
//> http://www.ymacs.org/
//>
//> Copyright (c) 2009-2012, Mihai Bazon, Dynarch.com.  All rights reserved.
//>
//> Redistribution and use in source and binary forms, with or without
//> modification, are permitted provided that the following conditions are
//> met:
//>
//>     * Redistributions of source code must retain the above copyright
//>       notice, this list of conditions and the following disclaimer.
//>
//>     * Redistributions in binary form must reproduce the above copyright
//>       notice, this list of conditions and the following disclaimer in
//>       the documentation and/or other materials provided with the
//>       distribution.
//>
//>     * Neither the name of Dynarch.com nor the names of its contributors
//>       may be used to endorse or promote products derived from this
//>       software without specific prior written permission.
//>
//> THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDER “AS IS” AND ANY
//> EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
//> IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
//> PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER BE LIABLE
//> FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
//> CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
//> SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
//> INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
//> CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
//> ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
//> THE POSSIBILITY OF SUCH DAMAGE.
function Ymacs_Exception(e){this.message=e}DEFINE_CLASS("Ymacs",DlLayout,function(e,t,n){function r(e,t){var n,r;if(e.length>0){n=e.peek().getPos().x,r=[e.pop()];while(e.length>0&&e.peek().getPos().x==n)r.push(e.pop());return r.minElement(function(e){return Math.abs(t.y-e.getPos().y-e.getSize().y/2)})}}function i(e,t){var n,r;if(e.length>0){n=e.peek().getPos().y,r=[e.pop()];while(e.length>0&&e.peek().getPos().y==n)r.push(e.pop());return r.minElement(function(e){return Math.abs(t.x-e.getPos().x-e.getSize().x/2)})}}function s(){if(!window.localStorage||!window.localStorage.getItem)throw new Ymacs_Exception("Local storage facility not available in this browser")}e.DEFAULT_EVENTS=["onBufferSwitch","onCreateBuffer","onDeleteBuffer"],e.DEFAULT_ARGS={buffers:["buffers",null],frames:["frames",null],cf_lineNumbers:["lineNumbers",!1],_focusable:["focusable",!0]},e.FIXARGS=function(e){e.buffers||(e.buffers=[]),e.frames||(e.frames=[])},e.CONSTRUCT=function(){var e;this.buffers.foreach(function(e){e.ymacs=this,this._addBufferListeners(e)},this),this.killRing=[],this.killMasterOfRings=[],this.progress={},this.minibuffer=this.createBuffer({hidden:!0,isMinibuffer:!0}),this.minibuffer.cmd("minibuffer_mode"),this.minibuffer_frame=this.createFrame({isMinibuffer:!0,buffer:this.minibuffer,hidden:!0,highlightCurrentLine:!1,className:"Ymacs_Minibuffer"}),this.buffers.length==0&&this.createBuffer(),e=this.createFrame({buffer:this.buffers[0]}),this.packWidget(this.minibuffer_frame,{pos:"bottom"}),this.packWidget(e,{pos:"top",fill:"*"}),this.setActiveFrame(e),e._redrawCaret()},t._addBufferListeners=function(e){var t=this;e.addEventListener("onDestroy",function(){var n=t.getActiveFrame();t.getBufferFrames(e).foreach(function(e){e!==n&&t.deleteFrame(e)}),t.buffers.remove(e),t.getActiveBuffer()===e&&t.nextHiddenBuffer(e)})},t.pushToKillRing=function(e,t){t?this.killRing.unshift(e):this.killRing.push(e)},t.killRingToMaster=function(){this.killRing.length&&(this.killMasterOfRings.length==0||this.killMasterOfRings.peek().join("")!=this.killRing.join(""))&&this.killMasterOfRings.push(this.killRing),this.killRing=[]},t.killRingText=function(){return this.killRing.join("")},t.rotateKillRing=function(e){e?(this.killMasterOfRings.push(this.killRing),this.killRing=this.killMasterOfRings.shift()):(this.killMasterOfRings.unshift(this.killRing),this.killRing=this.killMasterOfRings.pop())},t.getBuffer=function(e){return e instanceof Ymacs_Buffer||(e=this.buffers.grep_first(function(t){return t.name==e})),e},t.killBuffer=function(e){e=this.getBuffer(e),this.callHooks("onDeleteBuffer",e),e.destroy()},t.renameBuffer=function(e,t){e=this.getBuffer(e),e.name=t,e.callHooks("onProgressChange")},t._do_switchToBuffer=function(e){this.getActiveFrame().setBuffer(e),this.callHooks("onBufferSwitch",e)},t.switchToBuffer=function(e){var t=this.getBuffer(e),n=this.buffers;return t||(t=this.createBuffer({name:e})),n.remove(t),n.unshift(t),this._do_switchToBuffer(t),t},t.nextHiddenBuffer=function(e){var t,n=this.buffers.grep(function(t){if(t===e)return!1;var n=!0;return t.forAllFrames(function(){n=!1}),n});n.length>0?(t=n[0],this.buffers.remove(t),this.buffers.push(t),this._do_switchToBuffer(t)):this.switchToBuffer("*scratch*")},t.switchToNextBuffer=function(){var e,t=this.buffers;t.length>1&&(e=t.shift(),t.push(e),this._do_switchToBuffer(t[0]))},t.switchToPreviousBuffer=function(){var e,t=this.buffers;t.length>1&&(e=t.pop(),t.unshift(e),this._do_switchToBuffer(e))},t.getNextBuffer=function(e,t){var n;return t==null&&(t=1),n=this.buffers,n[n.rotateIndex(n.find(e)+t)]},t.getPrevBuffer=function(e,t){var n;return t==null&&(t=1),n=this.buffers,n[n.rotateIndex(n.find(e)-t)]},t.getBufferFrames=function(e){return e=this.getBuffer(e),this.frames.grep(function(t){return t.buffer===e})},t.createBuffer=function(e){var t;return e||(e={}),Object.merge(e,{ymacs:this}),t=new Ymacs_Buffer(e),this._addBufferListeners(t),e.hidden||this.buffers.push(t),this.callHooks("onCreateBuffer",t),t},t.createFrame=function(e){var t;return e||(e={}),Object.merge(e,{ymacs:this}),t=new Ymacs_Frame(e),e.hidden||this.frames.unshift(t),t.addEventListener("onDestroy",function(e){this.frames.remove(e)}.$(this,t)),t},t.keepOnlyFrame=function(e){var t;if(this.frames.length>1){t=e.parent;while(t.parent!=this)t=t.parent;this.replaceWidget(t,e),t.destroy(),this.setActiveFrame(e),this.doLayout()}},t.deleteFrame=function(e){var t,r;if(this.frames.length>1){t=e.parent,r=t.children().grep_first(function(t){return t instanceof DlLayout||t instanceof Ymacs_Frame&&t!==e}),t._resizeBar&&(t._resizeBar._widget=r),t.parent.replaceWidget(t,r),t.destroy();try{n.walk(r.getElement(),function(e){e=DlWidget.getFromElement(e);if(e&&e instanceof Ymacs_Frame)throw e})}catch(i){if(!(i instanceof Ymacs_Frame))throw i;r=i}this.setActiveFrame(r),this.doLayout()}},t.focusOtherFrame=function(){this.setActiveFrame(this.frames[0])},t.focus=function(){e.BASE.focus.apply(this,arguments),this.frames.peek().focus()},t.setActiveFrame=function(e,t){var n;e.isMinibuffer||(n=this.getActiveFrame(),n&&n.delClass("Ymacs_Frame-active"),this.frames.remove(e),this.frames.push(e)),t||e.focus()},t.getActiveFrame=function(){return this.frames.peek()},t.getActiveBuffer=function(){var e=this.getActiveFrame();return e?e.buffer:this.buffers.peek()},t.setColorTheme=function(e){this.delClass(/Ymacs-Theme-[^\s]*/g),e instanceof Array||(e=[e]),e.foreach(function(e){this.addClass("Ymacs-Theme-"+e)},this)},t.getFrameInDirection=function(e,t,r){var i,s,o;return r||(r=this.getActiveFrame()),i=r.getCaretElement(),t||(t=n.getPos(i)),t.sz||(t.sz=n.getOuterSize(i)),s=this.frames.mergeSort(function(e,t){return e.getPos().x-t.getPos().x}),o=this.frames.mergeSort(function(e,t){return e.getPos().y-t.getPos().y}),this["_get_frameInDir_"+e](s,o,t,r)},t._get_frameInDir_left=function(e,t,n,i){return e=e.grep(function(e){var t=e.getPos(),r=e.getSize();return e!==i&&t.x<n.x&&t.y-n.sz.y<=n.y&&t.y+r.y>n.y}),r(e,n)},t._get_frameInDir_right=function(e,t,n,i){return e.reverse(),e=e.grep(function(e){var t=e.getPos(),r=e.getSize();return e!==i&&t.x>n.x&&t.y-n.sz.y<=n.y&&t.y+r.y>n.y}),r(e,n)},t._get_frameInDir_up=function(e,t,n,r){return t=t.grep(function(e){var t=e.getPos(),i=e.getSize();return e!==r&&t.y<n.y&&t.x-n.sz.x<=n.x&&t.x+i.x>n.x}),i(t,n)},t._get_frameInDir_down=function(e,t,n,r){return t.reverse(),t=t.grep(function(e){var t=e.getPos(),i=e.getSize();return e!==r&&t.y>n.y&&t.x-n.sz.x<=n.x&&t.x+i.x>n.x}),i(t,n)},t.ls_get=function(){return s(),DlJSON.decode(localStorage.getItem(".ymacs")||"{}",!0)},t.ls_set=function(e){s(),localStorage.setItem(".ymacs",DlJSON.encode(e))},t.ls_getFileContents=function(e,t){var n,r=this.ls_getFileDirectory(e),i=r.other;i.length==1&&(n=r.dir[i[0]]);if(n==null&&!t)throw new Ymacs_Exception("File not found");return n},t.ls_setFileContents=function(e,t){var n=this.ls_getFileDirectory(e,"file");n.dir[n.other[0]]=t,this.ls_set(n.store)},t.ls_getFileDirectory=function(e,t){var n,r,i,s,o,u=n=this.ls_get();e=e.replace(/^[~\x2f]+/,"").split(/\x2f+/),r=[],i=[];while(e.length>0)s=e.shift(),u.hasOwnProperty(s)&&typeof u[s]!="string"?(u=u[s],r.push(s)):i.push(s);if(t){o=t=="file"?1:0;while(i.length>o)u=u[i.shift()]={};this.ls_set(n)}return{store:n,dir:u,path:r,other:i}}}),function(){function f(e,t){var n=a[e]||r[e]||s[e];return n?t?n[1]:n[0]:null}var e,t,n,r,i,s,o,u,a={};for(e=65;e<=90;++e)a[e]=[e,e+32];a[32]=[32,32],t=[16,17,18,20,144].toHash(!0),n=[[49,33],[50,64],[51,35],[52,36],[53,37],[54,94],[55,38],[56,42],[57,40],[48,41]],r=[49,50,51,52,53,54,55,56,57,48].toHash(function(e,t){return n[t]}),i=[[59,58],[61,43],[44,60],[45,95],[46,62],[47,63],[96,126],[91,123],[92,124],[93,125],[39,34]],s=(is_gecko?[59,61,188,109,190,191,192,219,220,221,222]:is_opera?[59,61,44,45,46,47,96,91,92,93,39]:[186,187,188,189,190,191,192,219,220,221,222]).toHash(function(e,t){return i[t]}),o=[37,38,39,40].toHash(!0),u=[45,46,36,35,33,34,112,113,114,115,116,117,118,119,120,121,122,123].toHash(!0),window.KEYBOARD_INSANITY={letters:a,modifiers:t,digits:r,symbols:s,arrows:o,specials:u,getCharCode:f}}(),window.Ymacs_Regexp=function(){function t(e){var t,n;return e instanceof RegExp&&(e=e+""),t=e.lastIndexOf("/"),n="",n=e.substr(t+1),e=e.substring(1,t),{pattern:e,flags:n}}var e={};return{search_backward:function(n){var r=n+"",i=e[r];return i||(n=t(r),n.flags=n.flags.replace(/g/g,"")+"g",i=RegExp("([^]*)("+n.pattern+")",n.flags),e[r]=i),i.lastIndex=0,i}}}(),DEFINE_CLASS("Ymacs_Frame",DlContainer,function(e,t,n){function c(e,t,n){function s(e){var o,u,a,f;for(o=e.firstChild;o;o=o.nextSibling)if(o.nodeType==3){u=o.length;if(r+u>t)throw a=t-r,f=o.splitText(a),e.insertBefore(n,f),i;if(r+u==t)throw e.insertBefore(n,o.nextSibling),i;r+=u}else o.nodeType==1&&s(o)}var r,i;if(/^br$/i.test(e.firstChild.tagName))return e.insertBefore(n,e.firstChild),n;r=0,i={};try{s(e)}catch(o){if(o===i)return n;throw o}}function h(){i=null}function p(e){var t=e.computePos(this.getContentElement()),n=this.coordinatesToRowCol(t.x,t.y);this.buffer.cmd("goto_char",this.buffer._rowColToPosition(n.row,n.col)),this.buffer.ensureTransientMark(),this.ensureCaretVisible()}function d(){DlEvent.releaseGlobals(this._dragSelectCaptures)}var r,i,s,o,u=300,a=DlException.stopEventBubbling,f=n.createElement("div",null,{className:"line",innerHTML:"<br/>"}),l=225;e.DEFAULT_EVENTS=["onPointChange"],e.DEFAULT_ARGS={highlightCurrentLine:["highlightCurrentLine",!0],buffer:["buffer",null],ymacs:["ymacs",null],isMinibuffer:["isMinibuffer",!1],_focusable:["focusable",!0],_fillParent:["fillParent",!0]},e.CONSTRUCT=function(){var e;this.__blinkCaret=this.__blinkCaret.$(this),this.__caretId=Dynarch.ID(),this.redrawModelineWithTimer=this.redrawModeline.clearingTimeout(0,this),this.getElement().innerHTML=r,this.addEventListener({onDestroy:this._on_destroy,onFocus:this._on_focus,onBlur:this._on_blur,onMouseDown:this._on_mouseDown,onKeyDown:this._on_keyDown,onKeyPress:this._on_keyPress,onKeyUp:this._on_keyUp,onResize:this._on_resize.clearingTimeout(5),onMouseWheel:this._on_mouseWheel}),this._dragSelectCaptures={onMouseOver:a,onMouseOut:a,onMouseEnter:a,onMouseLeave:a,onMouseMove:p.$(this),onMouseUp:d.$(this)},this._bufferEvents={onLineChange:this._on_bufferLineChange.$(this),onInsertLine:this._on_bufferInsertLine.$(this),onDeleteLine:this._on_bufferDeleteLine.$(this),onPointChange:this._on_bufferPointChange.$(this),onResetCode:this._on_bufferResetCode.$(this),onOverwriteMode:this._on_bufferOverwriteMode.$(this),onProgressChange:this._on_bufferProgressChange.$(this),beforeInteractiveCommand:this._on_bufferBeforeInteractiveCommand.$(this),afterInteractiveCommand:this._on_bufferAfterInteractiveCommand.$(this),onOverlayDelete:this._on_bufferOverlayDelete.$(this)},this._moreBufferEvents={onMessage:this._on_bufferMessage.$(this),onOverlayChange:this._on_bufferOverlayChange.$(this),afterInteractiveCommand:function(){this.__ensureCaretVisible&&this.ensureCaretVisible()}.$(this)},e=this.buffer,this.buffer=null,e&&this.setBuffer(e),!this.isMinibuffer&&this.ymacs.cf_lineNumbers&&this.toggleLineNumbers(),this.getOverlaysContainer().onscroll=this._on_scroll.$(this)},r=String.buffer("<div class='Ymacs-frame-overlays'>","<div class='Ymacs-frame-content'></div>","</div>","<div class='Ymacs_Modeline'></div>").get(),t.focus=function(t){e.BASE.focus.call(this),t instanceof Function&&(this.removeEventListener("onBlur",this.__exitFocusHandler),this.addEventListener("onBlur",this.__exitFocusHandler=function(){t.call(this.buffer)?this.removeEventListener("onBlur",this.__exitFocusHandler):this.focus.delayed(2,this,null)}))},t.blur=function(t){t&&this.removeEventListener("onBlur",this.__exitFocusHandler),e.BASE.blur.call(this)},t.getOverlaysContainer=function(){return this.getElement().firstChild},t.getModelineElement=function(){return this.getElement().childNodes[1]},t.getContentElement=function(){return this.getElement().firstChild.firstChild},t.getCaretElement=function(){return document.getElementById(this.__caretId)},t.getLineDivElement=function(e){return this.getContentElement().childNodes[e]||null},t.ensureCaretVisible=function(){var e,t,n,r,i;return this._redrawCaret(),e=!1,t=this.getCaretElement(),t?(n=this.getOverlaysContainer(),r=this.getLineDivElement(this.buffer._rowcol.row),i=r.offsetTop+r.offsetHeight-(n.scrollTop+n.clientHeight),i>0?(n.scrollTop+=i,e=!0):(i=r.offsetTop-n.scrollTop,i<0&&(n.scrollTop+=i,e=!0)),i=t.offsetLeft+t.offsetWidth-(n.scrollLeft+n.clientWidth),i>0?(n.scrollLeft+=i,e=!0):(i=t.offsetLeft-n.scrollLeft,i<0&&(n.scrollLeft+=i,e=!0)),e):e},t.setBuffer=function(e){this.buffer&&(this.caretMarker&&!this.isMinibuffer&&(this.caretMarker.destroy(),this.caretMarker=null),this.buffer.removeEventListener(this._bufferEvents),this.buffer.removeEventListener(this._moreBufferEvents)),this.buffer=e,e&&(this.buffer.addEventListener(this._bufferEvents),this.focusInside()&&e.addEventListener(this._moreBufferEvents),this.isMinibuffer?this.caretMarker=e.caretMarker:this.caretMarker=e.createMarker(e.caretMarker.getPosition(),!1,"framecaret"),this._redrawBuffer(),this._redrawCaret(!0),this.centerOnCaret())},t.centerOnCaret=function(){this.centerOnLine(this.buffer._rowcol.row)},t.centerOnLine=function(e){var t=this.getLineDivElement(e),n=this.getOverlaysContainer();n.scrollTop=Math.round(t.offsetTop-n.clientHeight/2+t.offsetHeight/2)},t.setModelineContent=function(e){this.getModelineElement().innerHTML=e},t.deleteOtherFrames=function(){this.ymacs.keepOnlyFrame(this)},t.deleteFrame=function(){this.ymacs.deleteFrame(this)},t.vsplit=function(e){var t,n,r,i;return e==null&&(e="50%"),t=this.parent,n=this.ymacs.createFrame({buffer:this.buffer}),r=new DlLayout,i=new DlResizeBar({widget:this,keepPercent:!0,horiz:!0,className:"Ymacs-splitbar-horiz"}),this._resizeBar&&(this._resizeBar._widget=r,r._resizeBar=this._resizeBar),this._resizeBar=i,t.replaceWidget(this,r),r.packWidget(this,{pos:"top",fill:e}),r.packWidget(i,{pos:"top"}),r.packWidget(n,{pos:"top",fill:"*"}),t.__doLayout(),n.centerOnCaret(),n},t.hsplit=function(e){var t,n,r,i;return e==null&&(e="50%"),t=this.parent,n=this.ymacs.createFrame({buffer:this.buffer}),r=new DlLayout,i=new DlResizeBar({widget:this,keepPercent:!0,className:"Ymacs-splitbar-vert"}),this._resizeBar&&(this._resizeBar._widget=r,r._resizeBar=this._resizeBar),this._resizeBar=i,t.replaceWidget(this,r),r.packWidget(this,{pos:"left",fill:e}),r.packWidget(i,{pos:"left"}),r.packWidget(n,{pos:"left",fill:"*"}),t.__doLayout(),n.centerOnCaret(),n},t.toggleLineNumbers=function(){this.condClass(this.__lineNumbers=!this.__lineNumbers,"Ymacs-line-numbers")},t.setMarkerAtPos=function(e,t){e.tagName||(e=this.getLineDivElement(e));if(e)return c(e,t,n.createElement("span"))},t.__restartBlinking=function(){this.__stopBlinking(),this.focusInside()&&(this.__caretTimer=setTimeout(this.__blinkCaret,2*l))},t.__stopBlinking=function(){clearTimeout(this.__caretTimer),this.__showCaret()},t.__blinkCaret=function(){n.condClass(this.getCaretElement(),this.BLINKING=!this.BLINKING,"Ymacs-caret"),this.__caretTimer=setTimeout(this.__blinkCaret,l)},t.__showCaret=function(){n.addClass(this.getCaretElement(),"Ymacs-caret")},t._unhoverLine=function(){this.__hoverLine!=null&&(n.delClass(this.getLineDivElement(this.__hoverLine),"Ymacs-current-line"),this.__hoverLine=null)},t._redrawCaret=function(e){var t,r=this.ymacs.getActiveFrame()===this;if(!e&&!r)return;r&&!this.isMinibuffer&&this.focusInside()&&this.caretMarker.setPosition(this.buffer.caretMarker.getPosition()),t=this.buffer._rowcol,this.highlightCurrentLine&&(this._unhoverLine(),n.addClass(this.getLineDivElement(t.row),"Ymacs-current-line"),this.__hoverLine=t.row),Array.$(this.getElement().querySelectorAll(".Ymacs-caret, #"+this.__caretId)).foreach(function(e){e.id="",e.className=""}),this.__prevCaretLine!=null&&this._on_bufferLineChange(this.__prevCaretLine),this.__prevCaretLine!=t.row&&(this.__prevCaretLine=t.row,this._on_bufferLineChange(t.row)),r&&this.__restartBlinking(),this.callHooks("onPointChange",t.row,t.col),this.redrawModelineWithTimer(t)},t._getLineHTML=function(e){var t=this.buffer.formatLineHTML(e,this.caretMarker),n=t.indexOf("Ymacs-caret'>");return n>=0&&(t=t.substr(0,n+12)+" id='"+this.__caretId+"'"+t.substr(n+12)),t},t._redrawBuffer=function(){this.setContent(this.buffer.code.map(function(e,t){return this._getLineHTML(t).htmlEmbed("div","line")},this).join(""))},t.coordinatesToRowCol=function(e,t){function s(e,r){var i,o,u,a;return e==r?e:(i=Math.floor((e+r)/2),o=n.getLineDivElement(i),u=o.offsetTop,a=u+o.offsetHeight-1,a<t?s(i+1,r):t<u?s(e,i-1):i)}function o(t,i){var s,u,a;return t==i?t:(s=Math.floor((t+i)/2),u=n.coordinates(r,s),a=n.coordinates(r,s+1),a.x<e?o(s+1,i):e<u.x?o(t,s-1):s)}var n,r,i;return n=this,r=s(0,this.buffer.code.length-1),i=o(0,this.buffer.code[r].length),{row:r,col:i}},t.coordinates=function(e,t){var r=this.getLineDivElement(e),i=this.setMarkerAtPos(r,t),s={x:i.offsetLeft,y:r.offsetTop,h:r.offsetHeight};return n.trash(i),s},t.heightInLines=function(){return Math.floor(this.getOverlaysContainer().clientHeight/this.getContentElement().firstChild.offsetHeight)},t.setOuterSize=t.setSize=function(t){e.BASE.setOuterSize.apply(this,arguments),n.setOuterSize(this.getOverlaysContainer(),t.x,t.y-this.getModelineElement().offsetHeight),n.setOuterSize(this.getModelineElement(),t.x)},t.redrawModeline=function(e){var t,n,r,i;e||(e=this.caretMarker.getRowCol()),t=this.buffer.code.length-1,n=this.firstLineVisible(),r=this.lastLineVisible(),i=n==0?"Top":r==t?"Bot":Math.round(r/t*100)+"%",this.setModelineContent(this.buffer.renderModelineContent(e,i))},t._on_bufferLineChange=function(e){var t=this.getLineDivElement(e);t&&(t.innerHTML=this._getLineHTML(e))},t._on_bufferInsertLine=function(e,t){var n=f.cloneNode(!0);this.getContentElement().insertBefore(n,this.getLineDivElement(e)),t&&(n.innerHTML=this._getLineHTML(e))},t._on_bufferDeleteLine=function(e){n.trash(this.getLineDivElement(e))},t._on_bufferPointChange=function(){this._redrawCaret()},t._on_bufferResetCode=function(){this._redrawBuffer()},t._on_bufferOverwriteMode=function(e){this.condClass(e,"Ymacs-overwrite-mode")},t._on_bufferMessage=function(e,t,n,r){var i=this.isMinibuffer?this.ymacs:this,s=Ymacs_Message_Popup.get(0);s.popup({content:n?t:t.htmlEscape(),widget:i,anchor:i.getElement(),align:{prefer:"CC",fallX1:"CC",fallX2:"CC",fallY1:"CC",fallY2:"CC"}}),s.hide(r||5e3)},t._on_bufferBeforeInteractiveCommand=function(){this.__ensureCaretVisible=!0,this._unhoverLine(),Ymacs_Message_Popup.clearAll()},t._on_bufferAfterInteractiveCommand=function(){},t._on_bufferProgressChange=function(){this.redrawModelineWithTimer(null)},t.getOverlayId=function(e){return this.id+"-ovl-"+e},t.getOverlayHTML=function(e,t){var n,r,i,s;return t.line1==t.line2&&t.col1==t.col2?(this._on_bufferOverlayDelete(e,t),null):(n=this.coordinates(t.line1,t.col1),r=this.coordinates(t.line2,t.col2),i=this.__lineNumbers?this.coordinates(t.line1,0):{x:0,y:0},n.x-=i.x,r.x-=i.x,s=String.buffer("<div id='",this.getOverlayId(e),"' class='Ymacs_Overlay ",e,"' style='top:",n.y,"px;left:",i.x,"px'>"),t.line1==t.line2?s("<div class='",e,"' style='margin-left:",n.x,"px; width:",r.x-n.x,"px;height:",r.h,"px;'>&nbsp;</div>"):(s("<div class='",e,"' style='margin-left:",n.x,"px;height:",n.h,"px;'>&nbsp;</div>"),t.line2-t.line1>1&&s("<div class='",e,"' style='height:",r.y-n.y-n.h,"px'></div>"),s("<div class='",e,"' style='width:",r.x,"px;height:",r.h,"px;'>&nbsp;</div>")),s("</div>"),s.get())},t.getOverlaysCount=function(){return this.getOverlaysContainer().childNodes.length-1},t._on_bufferOverlayChange=function(e,t,r){var i,s,o=this.getOverlayHTML(e,t);o&&(o=n.createFromHtml(o),i=this.getOverlaysContainer(),s=!r&&document.getElementById(this.getOverlayId(e)),s?i.replaceChild(o,s):i.appendChild(o))},t._on_bufferOverlayDelete=function(e){n.trash(document.getElementById(this.getOverlayId(e)))},t._on_destroy=function(){this.setBuffer(null),this.__stopBlinking()},t._on_focus=function(){window.focus(),this.ymacs.setActiveFrame(this,!0),this.addClass("Ymacs_Frame-active"),this.isMinibuffer||this.buffer.cmd("goto_char",this.caretMarker.getPosition()),this.buffer.addEventListener(this._moreBufferEvents),this._redrawCaret(),this.__restartBlinking()},t._on_blur=function(){this.isMinibuffer||this.caretMarker.setPosition(this.buffer.caretMarker.getPosition()),this.buffer.removeEventListener(this._moreBufferEvents),this.__stopBlinking()},i=0,s=null,o=null,t._on_mouseDown=function(e){var t,n,r;if(e.ctrlKey&&e.shiftKey)return;clearTimeout(s),i++,s=h.delayed(u),this.__restartBlinking(),t=e.computePos(this.getContentElement()),n=this.coordinatesToRowCol(t.x,t.y),r=this.buffer,r.clearTransientMark(),r.cmd("goto_char",r._rowColToPosition(n.row,n.col)),r.callInteractively("keyboard_quit"),i==1?(r.ensureTransientMark(),DlEvent.captureGlobals(this._dragSelectCaptures)):i==2?(r.cmd("backward_word"),r.cmd("forward_word_mark")):i==3?(r.cmd("beginning_of_line"),r.cmd("end_of_line_mark")):i==4&&(r.cmd("backward_paragraph"),r.cmd("forward_whitespace"),r.cmd("beginning_of_line"),r.cmd("forward_paragraph_mark")),a()},t._on_keyDown=function(e){var t,n;if(!is_gecko){t=window.KEYBOARD_INSANITY,n=e.keyCode,(n==0||n in t.modifiers)&&a();if((n in t.letters||n in t.digits||n in t.symbols)&&!e.ctrlKey&&!e.altKey)return;e.charCode=t.getCharCode(n,e.shiftKey),e.charCode&&(e.keyCode=0),this.buffer._handleKeyEvent(e)&&a()}},t._on_keyPress=function(e){is_gecko||(e.keyCode=0),this.buffer._handleKeyEvent(e)&&a()},t._on_keyUp=function(){},t._on_resize=function(){this.destroyed||(this.centerOnCaret(),this.redrawModelineWithTimer())},t._on_scroll=function(){this.redrawModelineWithTimer()},t._on_mouseWheel=function(e){this.buffer._handleKeyEvent(e),e.domStop=!0},t.firstLineVisible=function(){var e=this.getOverlaysContainer();return this.coordinatesToRowCol(1,e.scrollTop+1).row},t.lastLineVisible=function(){var e=this.getOverlaysContainer();return this.coordinatesToRowCol(e.clientWidth-2,e.scrollTop+e.clientHeight-2).row},t.scrollUp=function(e){var t=this.getOverlaysContainer(),n=Math.max(this.firstLineVisible()-e,0);n=this.getLineDivElement(n),t.scrollTop=n.offsetTop,this.__ensureCaretVisible=!1},t.scrollDown=function(e){var t=this.getOverlaysContainer(),n=Math.min(this.firstLineVisible()+e,this.buffer.code.length-1);n=this.getLineDivElement(n),t.scrollTop=n.offsetTop,this.__ensureCaretVisible=!1}}),DEFINE_CLASS("Ymacs_Message_Popup",DlPopup,function(e){e.FIXARGS=function(e){e.focusable=!1,e.autolink=!1,e.zIndex=5e3}}),DEFINE_CLASS("Ymacs_Text_Properties",DlEventProxy,function(e,t){e.DEFAULT_EVENTS=["onChange"],e.DEFAULT_ARGS={buffer:["buffer",null]},e.CONSTRUCT=t.reset=function(){this.props=[]},t.insertLine=function(e){this.props.length<e?this.props[e]=null:this.props.splice(e,0,null)},t.deleteLine=function(e){this.props.splice(e,1)},t.replaceLine=function(e,t){var n=this.props[e];n&&n.length>t.length&&n.splice(t.length,n.length)},t.addLineProps=function(e,t,n,r,i){var s,o=this.props,u=!1;if(t<n){o=o[e]||(o[e]=[]);while(t<n)s=o[t]||(o[t]={}),s[r]!=i&&(u=!0),s[r]=i,++t;u&&this.callHooks("onChange",e)}return u},t.removeLineProps=function(e,t,n,r){var i,s=this.props[e],o=!1;if(s&&t<n){while(t<n)i=s[t],i&&r in i&&(o=!0,delete i[r]),++t;o&&this.callHooks("onChange",e)}return o},t.getLineHTML=function(e,t,n){var r,i,s,o,u,a,f=this.props[e];if(n===null){if(t=="")return"<br/>";if(!f||f.length==0)return t.htmlEscape()}else{if(t=="")return"<span class='Ymacs-caret'>&nbsp;</span>";if(!f||f.length==0)return n===t.length?t.htmlEscape()+"<span class='Ymacs-caret'>&nbsp;</span>":t.substr(0,n).htmlEscape()+"<span class='Ymacs-caret'>"+t.charAt(n).htmlEscape()+"</span>"+t.substr(n+1).htmlEscape()}r=0,i=t.length,s=null,u="";while(r<i){o=f[r],o=o&&o.css,r===n&&(o=o?o+" Ymacs-caret":"Ymacs-caret"),o&&o!=s?(s&&(u+="</span>"),u+="<span class='"+o+"'>"):!o&&s&&(u+="</span>"),s=o,a=t.charAt(r);switch(a){case"<":u+="&lt;";break;case">":u+="&gt;";break;case"&":u+="&amp;";break;default:u+=a}++r}return s&&(u+="</span>"),r===n&&(u+="<span class='Ymacs-caret'>&nbsp;</span>"),u}}),function(){function n(e){var t=this.getPrefixArg(!0);t&&(e=t+" "+e),this.cmd("minibuffer_prompt",e)}function r(e,t){n.call(this,e),this.cmd("minibuffer_read_function",t)}function i(e,t){n.call(this,e),this.cmd("minibuffer_read_buffer",t)}function s(e,t){n.call(this,e),this.cmd("minibuffer_read_buffer",t)}function o(){}function u(e,t){n.call(this,e),this.cmd("minibuffer_read_command",t)}function a(e,t){t.call(this,this.point())}function f(){}function l(e,t){t.call(this,null)}function c(){}function h(){}function p(e,t){t.call(this,this.markMarker.getPosition())}function d(e,t){n.call(this,e),this.cmd("minibuffer_read_string",null,t)}function v(e,t){n.call(this,e),this.cmd("minibuffer_read_number",t)}function m(e,t){var n=parseInt(this.getPrefixArg(),10);isNaN(n)?v.call(this,e,t):t.call(this,n)}function g(e,t){var n=parseInt(this.getPrefixArg(),10);isNaN(n)&&(n=null),t.call(this,n)}function y(t,n){t=this.getPrefixArg(),t===""&&(t=e),n.call(this,t)}function b(e,t){var n=this.getRegion();t.call(this,n.begin,n.end)}function w(){}function E(e,t){n.call(this,e),this.cmd("minibuffer_read_variable",t)}function S(e,t){n.call(this,e),this.cmd("minibuffer_read_existing_file",t)}function x(e,t){n.call(this,e),this.cmd("minibuffer_read_file",t)}function T(e,t){n.call(this,e),this.cmd("minibuffer_read_file_or_directory",t)}function N(e,t){n.call(this,e),this.cmd("minibuffer_read_directory",t)}function C(e,n){var r=e.charAt(0);return e=e.substr(1),t[r].$(null,e,n)}var e,t;window.Ymacs_Interactive=function(e,t){var n,r,i,s;arguments.length==1?(t=e,e=null):t instanceof Function||(n=t,t=arguments[2],t.ymacsDoc=n),t.ymacsInteractive=!0;if(e instanceof Function)t.ymacsGetArgs=e;else if(e!=null){e instanceof Array||(r=/^[\^\@\*]+/.exec(e),r&&(r=r[0],e=e.substr(r.length),r.indexOf("^")>=0&&(t.ymacsMarkExtend=!0),r.indexOf("*")>=0&&(t.ymacsWarnReadonly=!0),r.indexOf("@")>=0&&(t.ymacsSelectFrame=!0)),e&&(e=e.split(/\n+/)));if(e){s=function(){return i.append(Array.$(arguments)),this.callInteractively(t,i,!0)};while(e.length>0)s=C(e.pop(),function(e){i.append(Array.$(arguments,1)),e.call(this)}.$(null,s));t.ymacsCallInteractively=function(){return i=[],s.call(this)}}}return t},window.Ymacs_Interactive_X=function(e){return Ymacs_Interactive("p",function(t){t==null&&(t=1),t.times(e,this)})},e=function(){},e.toString=function(){return""},e.empty=!0,t={a:r,b:i,B:s,c:o,C:u,d:a,e:f,i:l,k:c,K:h,m:p,M:d,n:v,N:m,p:g,P:y,r:b,s:d,U:w,v:E,f:S,F:x,G:T,D:N}}(),DEFINE_CLASS("Ymacs_Buffer",DlEventProxy,function(e,t){function o(e,t){var n,r;if(typeof e=="string")return t===undefined?delete this[e]:this[e]=t,t instanceof Function&&(t.ymacsCommand=e),t;n={};for(r in e)n[r]=this[r],o.call(this,r,e[r]);return n}function u(e){return e instanceof Ymacs_Marker?e.getPosition():e}function a(e){var t;if(e)return t=e.charCodeAt(0),t>=48&&t<=57||e.toUpperCase()!=e.toLowerCase()}function f(e){var t;if(e)return t=e.charCodeAt(0),t>=48&&t<=57||e=="_"||e.toUpperCase()!=e.toLowerCase()}var n,r,i,s;e.DEFAULT_EVENTS=["onLineChange","onInsertLine","onDeleteLine","onPointChange","onResetCode","onMessage","onOverwriteMode","onOverlayChange","onOverlayDelete","beforeInteractiveCommand","afterInteractiveCommand","beforeRedraw","afterRedraw","finishedEvent","onProgressChange","onTextInsert","onTextDelete"],e.DEFAULT_ARGS={name:["name","*scratch*"],_code:["code",null],ymacs:["ymacs",null],tokenizer:["tokenizer",null],isMinibuffer:["isMinibuffer",!1]},n={case_fold_search:!0,line_movement_requested_col:0,fill_column:78,tab_width:8,indent_level:8,syntax_word:{test:a},syntax_word_dabbrev:{test:f},syntax_paragraph_sep:/\n\s*\n/g},r=5e4,t.lastIndexOfRegexp=function(e,t,n,r){var i,s;e=e.substring(0,n),t=Ymacs_Regexp.search_backward(t),t.lastIndex=r||0,i=t.exec(e);if(i)return s=Array.$(i,2),s.index=i.index+i[1].length,s.after=i.index+i[0].length,s[0]=e.substring(s.index,s.after),this.matchData=s,s},e.COMMANDS=t.COMMANDS={},e.newCommands=t.newCommands=function(){return o.apply(this.COMMANDS,arguments)},e.replaceCommands=t.replaceCommands=function(e){var t;return this.COMMANDS=Object.makeCopy(this.COMMANDS),t={},Object.foreach(e,function(e,n){typeof e=="string"&&(e=this[e]),t[n]=e},this.COMMANDS),this.newCommands(t)},e.newMode=t.newMode=function(t,n){var r="*"+t+"*",i=r+"hooks";e.setGlobal(i,[]),this.COMMANDS[t]=Ymacs_Interactive("P",function(e){var s,o=this.getq(r);return o?e!==!0&&(this.getq(i).foreach(function(e){e.call(this,!1)},this),o instanceof Function&&o.call(this),this.setq(r,null),this.modes.remove(t)):e!==!1&&(s=n.apply(this,arguments),s instanceof Function||(s=!0),this.setq(r,s),this.modes.push(t),this.getq(i).foreach(function(e){e.call(this,!0)},this)),o})},e.addModeHook=t.addModeHook=function(e,t){var n;typeof t=="string"&&(t=this.COMMANDS[t]),n="*"+e+"*hooks",this.getq(n).pushUnique(t)},e.removeModeHook=t.removeModeHook=function(e,t){var n;typeof t=="string"&&(t=this.COMMANDS[t]),n="*"+e+"*hooks",this.getq(n).remove(t)},e.FIXARGS=function(e){e.code==null&&(e.code="")},e.CONSTRUCT=function(){this.__savingExcursion=0,this.__preventUpdates=0,this.__preventUndo=0,this.__undoInProgress=0,this.__dirtyLines=[],this.__undoQueue=[],this.__redoQueue=[],this.__overlays={},this.markers=[],this.caretMarker=this.createMarker(0,!1,"point"),this.markMarker=this.createMarker(0,!0,"mark"),this.matchData=[],this.previousCommand=null,this.currentCommand=null,this.currentKeys=[],this.progress={},this.variables={},this.globalVariables=n,this.modes=[],this.caretMarker.onChange.push(function(){this._rowcol=this.caretMarker.getRowCol(),this.__preventUpdates==0&&this.callHooks("onPointChange",this._rowcol,this.point())}),this._tokenizerEvents={onFoundToken:this._on_tokenizerFoundToken.$(this)},this._textProperties=new Ymacs_Text_Properties({buffer:this}),this._textProperties.addEventListener("onChange",this._on_textPropertiesChange.$(this)),this.keymap=[],this.pushKeymap(this.makeDefaultKeymap()),this.setCode(this._code),this._lastCommandWasKill=0,delete this._code},t.withVariables=function(e,t){var n,r={};for(n in e)r[n]=this.variables[n],this.variables[n]=e[n];try{return t instanceof Function?t.apply(this,Array.$(arguments,2)):this.cmdApply(t,Array.$(arguments,2))}finally{for(n in r)r[n]===undefined?delete this.variables[n]:this.variables[n]=r[n]}},t.withCommands=function(e,t){var n=this.COMMANDS;this.COMMANDS=Object.makeCopy(n),Object.merge(this.COMMANDS,e);try{return t instanceof Function?t.apply(this,Array.$(arguments,2)):this.cmdApply(t,Array.$(arguments,2))}finally{this.COMMANDS=n}},t.getVariable=function(e){return e in this.variables?this.variables[e]:n[e]},t.setVariable=function(){return o.apply(this.variables,arguments)},e.setq=e.setVariable=e.setGlobal=t.setGlobal=function(){return o.apply(n,arguments)},t.setq=t.setVariable,t.getq=t.getVariable,e.getq=e.getVariable=function(e){return n[e]},t.pushKeymap=function(e){e instanceof Array?e.foreach(this.pushKeymap,this):(this.popKeymap(e),this.keymap.push(e),e.attached(this))},t.popKeymap=
function(e){this.keymap.remove(e),e.detached(this)},t.makeDefaultKeymap=function(){return Ymacs_Keymap_Emacs()},t.signalError=function(e,t,n){this.callHooks("onMessage","error",e,t,n)},t.signalInfo=function(e,t,n){this.callHooks("onMessage","info",e,t,n)},t.createMarker=function(e,t,n){return e==null&&(e=this.point()),new Ymacs_Marker({editor:this,pos:e,name:n,before:t})},t.point=function(){return this.caretMarker.getPosition()},t.setCode=function(e){this.__code=e,this.__size=e.length,this.__undoQueue=[],this.__redoQueue=[],this.__overlays={},this.markers.map("setPosition",0,!0,!0),this.code=e.split(/\n/),this._textProperties.reset(),this.tokenizer&&this.tokenizer.reset(),this.callHooks("onResetCode",this.code),this.caretMarker.setPosition(0,!1,!0),this.markMarker.setPosition(0,!0),this.forAllFrames(function(e){e.ensureCaretVisible(),e.redrawModelineWithTimer()})},t.setTokenizer=function(e){this.tokenizer!=null&&this.tokenizer.removeEventListener(this._tokenizerEvents),this.tokenizer=e,e?e.addEventListener(this._tokenizerEvents):(this._textProperties.reset(),this.callHooks("onResetCode",this.code))},t.getCode=function(){return this.__code||(this.__code=this.code.join("\n"))},t.getCodeSize=function(){var e,t;if(this.__size)return this.__size;e=this.code.length,t=e>0?-1:0;while(--e>=0)t+=this.code[e].length+1;return this.__size=t},t.getLine=function(e){return e==null&&(e=this._rowcol.row),this.code[e]},t.charAtRowCol=function(e,t){var n,r=this.code.length;return e<r--?(n=this.code[e],t==n.length?e==r&&n.charAt(t)||"\n":n.charAt(t)):null},t.charAt=function(e){var t;return e==null?e=this.point():(e=u(e),e<0&&(e+=this.point())),t=this._positionToRowCol(e),this.charAtRowCol(t.row,t.col)},t.callInteractively=function(e,t,n){var r;t||(t=[]),e instanceof Function?r=e.ymacsCommand||null:(r=e,e=this.COMMANDS[e]);if(e.ymacsCallInteractively&&!n)return e.ymacsCallInteractively.apply(this,t);this.currentCommand=r,r!="undo"&&(this.__undoQueue=this.__undoQueue.concat(this.__redoQueue),this.__redoQueue=[]),this.previousCommand!=r?(this.sameCommandCount(0),r!="undo"&&this._placeUndoBoundary()):(r!="self_insert_command"||this.sameCommandCount()%20==0)&&r!="undo"&&this._placeUndoBoundary(),this.preventUpdates();try{return this.callHooks("beforeInteractiveCommand",r,e),e.ymacsMarkExtend||this.clearTransientMark(),e.apply(this,t)}catch(i){if(!(i instanceof Ymacs_Exception))throw i;this.signalError(i.message)}finally{this.resumeUpdates(),this.callHooks("afterInteractiveCommand",r,e),this.previousCommand=r,this.sameCommandCount(1)}},t.resetOverwriteMode=function(e){arguments.length==0&&(e=this.overwriteMode),this.callHooks("onOverwriteMode",this.overwriteMode=!e),this.signalInfo(e?"Insert mode":"Overwrite mode")},t.getMinibuffer=function(){return this.whenYmacs(function(e){return e.minibuffer})},t.getMinibufferFrame=function(){return this.whenYmacs(function(e){return e.minibuffer_frame})},t.setMinibuffer=function(e){this.whenMinibuffer(function(t){t.setCode(e),t.cmd("end_of_buffer")})},t.cmd=function(e){return this.COMMANDS[e].apply(this,Array.$(arguments,1))},t.cmdApply=function(e,t){return this.COMMANDS[e].apply(this,t)},t.createDialog=function(e){var t;return e.parent||(e.parent=this.getActiveFrame()&&this.getActiveFrame().getParentDialog(),"noShadows"in e||(e.noShadows=!0)),t=new DlDialog(e),this.whenActiveFrame(function(e){t.addEventListener("onDestroy",e.focus.clearingTimeout(0,e))}),t},t.getActiveFrame=function(){return this.whenYmacs("getActiveFrame")},t.when=function(e,t){e=this[e]||this.getq(e);if(e!=null)return t instanceof Function?t.call(this,e):e[t].apply(e,Array.$(arguments,2))},t.whenActiveFrame=function(){var e,t=this.getActiveFrame();if(t.buffer===this)return this.activeFrame=t,e=Array.$(arguments),e.unshift("activeFrame"),this.when.apply(this,e);this.activeFrame=null},t.forAllFrames=function(e){this.ymacs&&this.ymacs.getBufferFrames(this).foreach(e)},t.whenYmacs=function(){var e=Array.$(arguments);return e.unshift("ymacs"),this.when.apply(this,e)},t.whenMinibuffer=function(e){return this.whenYmacs(function(t){if(t.minibuffer)return e.call(this,t.minibuffer)})},t.preventUpdates=function(){++this.__preventUpdates},t.resumeUpdates=function(){(this.__preventUpdates=Math.max(this.__preventUpdates-1,0))==0&&this.redrawDirtyLines()},t.getRegion=function(e,t){var n;return e==null&&(e=this.caretMarker),t==null&&(t=this.markMarker),e=u(e),t=u(t),t<e&&(n=e,e=t,t=n),{begin:e,end:t}},t.redrawDirtyLines=function(){this.callHooks("beforeRedraw"),this.__dirtyLines.foreach(function(e,t){e&&this.callHooks("onLineChange",t)},this),this.__dirtyLines=[],this.callHooks("afterRedraw")},t.getOverlays=function(){return this.__overlays},t.getOverlay=function(e){return this.__overlays[e]},t.setOverlay=function(e,t){var n,r=this.__overlays[e],i=!r;i?r=this.__overlays[e]=t:Object.merge(r,t),r.line2<r.line1?(n=r.line2,r.line2=r.line1,r.line1=n,n=r.col2,r.col2=r.col1,r.col1=n):r.line2==r.line1&&r.col2<r.col1&&(n=r.col2,r.col2=r.col1,r.col1=n),this.callHooks("onOverlayChange",e,r,i)},t.deleteOverlay=function(e){delete this.__overlays[e],this.callHooks("onOverlayDelete",e)},t.ensureTransientMark=function(){var e,t=this._rowcol;this.transientMarker||(this.transientMarker=this.createMarker(),this.markMarker.setPosition(this.point()),e=t),e||(e=this.transientMarker.getRowCol()),this.setOverlay("selection",{line1:e.row,col1:e.col,line2:t.row,col2:t.col})},t.clearTransientMark=function(){this.transientMarker&&(this.transientMarker.destroy(),this.transientMarker=null,this.deleteOverlay("selection"))},t.deleteTransientRegion=function(){if(this.transientMarker)return this._deleteText(this.caretMarker,this.transientMarker),this.clearTransientMark(),this._placeUndoBoundary(),!0},i=0,t.sameCommandCount=function(e){return e==null?i:i+=e},t.interactiveEvent=function(e){return arguments.length==0?s:s=e},t.getPrefixArg=function(e){var t=this.getq("universal_prefix");return e||(this.setq("universal_prefix",undefined),this.isMinibuffer||this.setMinibuffer("")),t},t.setPrefixArg=function(e){return this.setq("universal_prefix",e)},t.updateProgress=function(e,t){t==null?delete this.progress[e]:this.progress[e]=t,this.callHooks("onProgressChange")},t.renderModelineContent=function(e,t){var n,r,i=String.buffer("-- <b>",this.name.htmlEscape(),"</b>","  ",t," of ",this.getCodeSize().formatBytes(2).toLowerCase(),"  ","(",e.row+1,",",e.col,") "),s=this.getq("modeline_custom_handler");s&&(s=s.call(this,this,e),s&&i("[",s,"] ")),n=[];for(r in this.progress)n.push(r+": "+this.progress[r]);return n.length>0&&i("{",n.join(", "),"}"),i.get()},t._recordChange=function(e,t,n,i){var s;n>0&&(s=this.__undoQueue,s.push({type:e,pos:t,len:n,text:i}),s.length>r&&s.shift())},t._placeUndoBoundary=function(e){var t,n;e=e||this.__undoQueue,t=this.markers.map(function(e){return[e,e.getPosition()]}),n=e.peek(),!n||n.type!=3?e.push({type:3,markers:t}):n.markers=t},t._playbackUndo=function(e){var t,n,r;++this.__undoInProgress,t=!1;while(e.length>0&&e.peek().type==3)n=e.pop();while(e.length>0){n=e.pop();if(n.type==3){n.markers.foreach(function(e){e[0].setPosition(e[1])});break}t=!0,r=n.pos;switch(n.type){case 1:this._deleteText(r,r+n.len);break;case 2:this._insertText(n.text,r)}}return--this.__undoInProgress,t},t._replaceLine=function(e,t){this.code[e]=t,this._textProperties.replaceLine(e,t),this.__preventUpdates==0?this.callHooks("onLineChange",e):this.__dirtyLines[e]=!0},t._deleteLine=function(e){this.code.splice(e,1),this._textProperties.deleteLine(e),this.tokenizer&&this.tokenizer.quickDeleteLine(e),this.__dirtyLines.splice(e,1),this.callHooks("onDeleteLine",e)},t._insertLine=function(e,t){var n;this.code.splice(e,0,t),this._textProperties.insertLine(e),this.tokenizer&&this.tokenizer.quickInsertLine(e),n=this.__preventUpdates==0,this.callHooks("onInsertLine",e,n),n||(this.__dirtyLines.length>e?this.__dirtyLines.splice(e,0,!0):this.__dirtyLines[e]=!0)},t._insertText=function(e,t){var n,r,i,s,o;if(e.length==0)return;t==null&&(t=this.caretMarker.getPosition()),t=u(t),this.__preventUndo==0&&this._recordChange(1,t,e.length),n=t==this.point()?this._rowcol:this._positionToRowCol(t),r=n.row,/^\n+$/.test(e)&&n.col==0?e.length.times(function(e){this._insertLine(r+e,"")},this):(i=e.split("\n"),s=this.code[r],o=s.substr(n.col),i.length>1?(this._replaceLine(r,s.substr(0,n.col)+i.shift()),i.foreach(function(e){this._insertLine(++r,e)},this),this._replaceLine(r,this.code[r]+o)):this._replaceLine(r,s.substr(0,n.col)+i[0]+s.substr(n.col))),this._updateMarkers(t,e.length),this.callHooks("onTextInsert",t,e)},t._deleteText=function(e,t){var n,r,i,s;e=this._boundPosition(u(e)),t=this._boundPosition(u(t));if(e==t)return;t<e&&(n=e,e=t,t=n),this.__preventUndo==0&&this._recordChange(2,e,t-e,this._bufferSubstring(e,t)),r=this._positionToRowCol(e),i=this._positionToRowCol(t),s=this.code[r.row],r.row==i.row?(s=s.substr(0,r.col)+s.substr(i.col),this._replaceLine(r.row,s)):(s=s.substr(0,r.col)+this.code[i.row].substr(i.col),this._replaceLine(r.row,s),s=r.row+1,(i.row-r.row).times(this._deleteLine.$(this,s))),this._updateMarkers(e,e-t,e),this.callHooks("onTextDelete",e,t)},t._replaceText=function(e,t,n){this._deleteText(e,t),this._insertText(n,e)},t._swapAreas=function(e){var t,n,r,i,s,o;return e=e.map(u).mergeSort(),t=e[0],n=e[1],r=e[2],i=e[3],s=this._bufferSubstring(t,n),o=this._bufferSubstring(r,i),this._replaceText(r,i,s),this._replaceText(t,n,o),i},t._bufferSubstring=function(e,t){var n;return e==null?e=this.point():e=u(e),t==null?t=this.getCodeSize():t=u(t),t<e&&(n=e,e=t,t=n),this.getCode().substring(e,t)},t._killingAction=function(e,t,n,r){var i;e=u(e),t=u(t),i=this._bufferSubstring(e,t),this._saveKilledText(i,n),r||this._deleteText(e,t)},t._saveKilledText=function(e,t){this._lastCommandWasKill||this.ymacs.killRingToMaster(),this.ymacs.pushToKillRing(e,t),this._lastCommandWasKill++},t._positionToRowCol=function(e){var t,n=0,r=this.code,i=r.length;while(e>0&&n<i){t=r[n].length;if(t>=e)break;e-=t+1,n++}return{row:n,col:e}},t._rowColToPosition=function(e,t){var n=0,r=this.code,i=Math.min(e,r.length-1),s=i;if(i<0)return 0;while(--i>=0)n+=r[i].length+1;return n+Math.min(t,r[s].length)},t._boundPosition=function(e){return e<0?0:Math.min(e,this.getCodeSize())},t._repositionCaret=function(e){var t=this.caretMarker.getPosition();return e==null&&(e=t),e=u(e),e=this._boundPosition(e),this.caretMarker.setPosition(e),e!=t},t._updateMarkers=function(e,t,n){this.__size=null,this.__code=null,this.markers.map("editorChange",e,t,n||0),this.tokenizer&&this.tokenizer.quickUpdate(Math.min(e,e+t))},t._saveExcursion=function(e,t){var n=this.createMarker(null,t);++this.__savingExcursion;try{return e.call(this)}finally{--this.__savingExcursion,this.caretMarker.swap(n,!1,!0),n.destroy()}},t._disableUndo=function(e){++this.__preventUndo;try{return e.call(this)}finally{--this.__preventUndo}},t._handleKeyEvent=function(e){var t,n,r,i,s=!1;return this.interactiveEvent(e),t=this._lastCommandWasKill,this.__nextIsMeta&&(e.altKey=!0),this.__nextIsMeta=!1,n=Ymacs_Keymap.unparseKey(e),r=this.currentKeys,i=!1,r.push(n),this.keymap.r_foreach(function(e){var t=e.getHandler(r);t instanceof Array?(this.callInteractively(t[0],t[1]),s=!0):t?s=i=!0:n==="ESCAPE"?(this.__nextIsMeta=!0,s=!0):e.defaultHandler&&r.length==1&&(s=this.callInteractively(e.defaultHandler[0],e.defaultHandler[1])),s&&$BREAK()},this),i||(s||r.length>1&&(this.signalError(r.join(" ").bold()+" is undefined",!0),s=!0),r.splice(0,r.length)),this._lastCommandWasKill==t&&typeof s!="object"&&(this._lastCommandWasKill=0),this.callHooks("finishedEvent",s),this.interactiveEvent(null),s},t._on_tokenizerFoundToken=function(e,t,n,r){r?this._textProperties.addLineProps(e,t,n,"css",r):this._textProperties.removeLineProps(e,t,n,"css")},t._on_textPropertiesChange=function(e){this.__preventUpdates==0?this.callHooks("onLineChange",e):this.__dirtyLines[e]=!0},t.formatLineHTML=function(e,t){var n=this._rowcol;return t instanceof Ymacs_Marker&&(n=t.getRowCol()),t=e==n.row?n.col:null,this._textProperties.getLineHTML(e,this.code[e],t)}}),DEFINE_CLASS("Ymacs_Marker",null,function(e,t){e.DEFAULT_ARGS={position:["pos",null],editor:["editor",null],before:["before",!1],name:["name",null]},e.CONSTRUCT=function(){this.editor.markers.push(this),this.rowcol=null,this.onChange=[]},t.destroy=function(){this.editor.markers.remove(this),this.editor=null},t.editorChange=function(e,t,n){var r=this.position;this.before&&--r,t!=0&&e<=r&&(this.rowcol=null,this.position+=t,this.position<n&&(this.position=n),this.callHooks(this.onChange,this.position))},t.callHooks=function(e,t){var n;for(n=e.length;--n>=0;)e[n].call(this.editor,t)},t.getPosition=function(){return this.position},t.setPosition=function(e,t,n){if(n||this.position!=e)this.rowcol=null,this.position=e,t||this.callHooks(this.onChange,this.position)},t.getRowCol=function(){return this.rowcol||(this.rowcol=this.editor._positionToRowCol(this.position))},t.updateMarkers=function(e){this.editor._updateMarkers(this.getPosition(),e)},t.swap=function(e,t,n){var r=this.getPosition();this.setPosition(e.getPosition(),t,n),e.setPosition(r,t,n)}}),Ymacs_Buffer.newCommands({forward_char:Ymacs_Interactive("p",function(e){return e==null&&(e=1),this.cmd("goto_char",this.point()+e)}),backward_char:Ymacs_Interactive("p",function(e){return e==null&&(e=1),this.cmd("forward_char",-e)}),forward_line:Ymacs_Interactive("p",function(e){var t,n;return e==null&&(e=1),t=this._rowcol,/^(forward|backward)_line$/.test(this.previousCommand)||this.setq("line_movement_requested_col",t.col),n=this.cmd("goto_char",this._rowColToPosition(t.row+e,Math.max(t.col,this.getq("line_movement_requested_col")))),n||this.setq("line_movement_requested_col",t.col),n}),backward_line:Ymacs_Interactive("p",function(e){return e==null&&(e=1),this.cmd("forward_line",-e)}),forward_whitespace:Ymacs_Interactive("P",function(e){var t=e?/[^\x20\t\xA0]/g:/[^\s]/g;if(this.cmd("search_forward_regexp",t))return this.cmd("backward_char"),!0;if(!e)return this.cmd("end_of_buffer")}),backward_whitespace:Ymacs_Interactive("P",function(e){var t=e?/[^\x20\t\xA0]/g:/[^\s]/g;if(this.cmd("search_backward_regexp",t))return this.cmd("forward_char"),!0;if(!e)return this.cmd("beginning_of_buffer")}),beginning_of_line:Ymacs_Interactive(function(){return this.cmd("goto_char",this._rowColToPosition(this._rowcol.row,0))}),back_to_indentation:Ymacs_Interactive(function(){var e=this._rowcol,t=this.code[e.row],n=/\S/.exec(t);if(n)return this.cmd("goto_char",this._rowColToPosition(e.row,n.index))}),beginning_of_indentation_or_line:Ymacs_Interactive(function(){return this.cmd("back_to_indentation")||this.cmd("beginning_of_line")}),end_of_line:Ymacs_Interactive(function(){var e=this._rowcol;return this.cmd("goto_char",this._rowColToPosition(e.row,this.code[e.row].length))}),beginning_of_buffer:Ymacs_Interactive(function(){return this.cmd("goto_char",0)}),end_of_buffer:Ymacs_Interactive(function(){return this.cmd("goto_char",this.getCodeSize())}),eob_p:function(){return this.point()==this.getCodeSize()},bob_p:function(){return this.point()==0},eol_p:function(){var e=this._positionToRowCol(this.point());return e.col==this.code[e.line].length},bol_p:function(){return this._positionToRowCol(this.point()).col==0},backward_delete_char:Ymacs_Interactive("^p",function(e){var t;this.deleteTransientRegion()||(e==null&&(e=1),t=this.point(),t>0&&this._deleteText(t-e,t))}),delete_char:Ymacs_Interactive("^p",function(e){var t;this.deleteTransientRegion()||(e==null&&(e=1),t=this.point(),this._deleteText(t,t+e))}),delete_whitespace:Ymacs_Interactive("^P",function(e){var t;if(!this.deleteTransientRegion()){t=this.point();if(this.cmd("forward_whitespace",e))return this._deleteText(t,this.point()),!0}}),backward_delete_whitespace:Ymacs_Interactive("^P",function(e){var t;if(!this.deleteTransientRegion()){t=this.point();if(this.cmd("backward_whitespace",e))return this._deleteText(this.point(),t),!0}}),delete_indentation:Ymacs_Interactive("P",function(e){e&&this.cmd("forward_line"),this.cmd("back_to_indentation"),this.cmd("backward_delete_whitespace"),this.cmd("insert"," ")}),universal_argument:Ymacs_Interactive("^",function(){this.pushKeymap(Ymacs_Keymap_UniversalArgument()),this.isMinibuffer||this.setMinibuffer("C-u")}),overwrite_mode:Ymacs_Interactive(function(){this.resetOverwriteMode()}),self_insert_command:Ymacs_Interactive("^p",function(e){var t,n,r=this.interactiveEvent(),i=String.fromCharCode(r.charCode),s=this._rowcol;return r.charCode&&i&&!r.altKey&&!r.ctrlKey?(this.deleteTransientRegion(),e!=null&&(i=i.x(e)),this.overwriteMode&&(t=this.code[s.row],n=t.length-s.col,n>0&&this.cmd("delete_char",Math.min(n,e||1))),this.cmd("insert",i),r.domStop=!0,!0):!1}),newline:Ymacs_Interactive("^p",function(e){e==null&&(e=1),this.deleteTransientRegion(),this.cmd("insert","\n".x(e))}),newline_and_indent:Ymacs_Interactive("^p",function(e){e?this.cmd("newline",e):(this.cmd("backward_delete_whitespace",!0),this.cmd("newline"),this.cmd("indent_line"))}),indent_line:Ymacs_Interactive("P",function(e){var t,n;if(this.tokenizer){t=this.tokenizer.getIndentation(this._rowcol.row,this);if(t!=null){if(!e||/\S/.test(this.getLine()))n=this.cmd("save_excursion",function(){return this.cmd("back_to_indentation"),this._rowcol.col!=t&&(this.cmd("beginning_of_line"),this.cmd("delete_whitespace",!0),this.cmd("insert"," ".x(t))),this.point()}),this.point()<n&&this.cmd("goto_char",n);return}}this.cmd("insert"," ".x(this.getq("indent_line")))}),indent_region:Ymacs_Interactive("r",function(e,t){var n;t<e&&(n=e,e=t,t=n),this.cmd("save_excursion",function(){var n=this.createMarker(t);this.cmd("goto_char",e);while(this.point()<n.getPosition()){this.cmd("indent_line",!0),this.cmd("beginning_of_line");if(!this.cmd("forward_line"))break}n.destroy()})}),make_marker:function(e){return this.createMarker(e)},looking_at:function(e){var t=e.lastIndex=this.point(),n=this.matchData=e.exec(this.getCode());return n&&(n.after=e.lastIndex),n&&n.index==t},looking_back:function(e){var t=this.lastIndexOfRegexp(this.getCode(),e,this.point());return t&&t.after==this.point()},search_forward:Ymacs_Interactive("sSearch: ",function(e,t){var n,r=this.getCode(),i=this.point();this.getq("case_fold_search")&&(r=r.toLowerCase(),e=e.toLowerCase()),n=r.indexOf(e,i);if(n>=0&&(t==null||n<=t))return this.cmd("goto_char",n+e.length),!0}),search_backward:Ymacs_Interactive("sSearch backward: ",function(e,t){var n,r=this.getCode(),i=this.point();this.getq("case_fold_search")&&(r=r.toLowerCase(),e=e.toLowerCase()),n=r.lastIndexOf(e,i),n==i&&(n=r.lastIndexOf(e,i-1));if(n>=0&&n!=i&&(t==null||n>=t))return this.cmd("goto_char",n),!0}),make_regexp:function(e){var t;if(!(e instanceof RegExp)){t=e.toLowerCase()!=e.toUpperCase();try{e=RegExp(e,t?"ig":"g")}catch(n){throw new Ymacs_Exception("Invalid regexp")}}return e},search_forward_regexp:Ymacs_Interactive("sRegExp search: ",function(e){var t,n,r;e=this.cmd("make_regexp",e),t=this.getCode(),n=e.lastIndex=this.point(),r=this.matchData=e.exec(t);if(r&&e.lastIndex!=n)return r.after=e.lastIndex,this.cmd("goto_char",e.lastIndex),!0}),search_backward_regexp:Ymacs_Interactive("sBackward RegExp search: ",function(e){var t;e=this.cmd("make_regexp",e),t=this.lastIndexOfRegexp(this.getCode(),e,this.point());if(t&&t.index!=this.point())return this.cmd("goto_char",t.index),!0}),forward_word:Ymacs_Interactive_X(function(){var e=this.getq("syntax_word"),t=!1;while(!t&&!e.test(this.charAt()))this.cmd("forward_char")||(t=!0);while(!t&&e.test(this.charAt()))this.cmd("forward_char")||(t=!0)}),backward_word:Ymacs_Interactive_X(function(){var e=this.getq("syntax_word"),t=!1;while(!t&&!e.test(this.charAt(-1)))this.cmd("backward_char")||(t=!0);while(!t&&e.test(this.charAt(-1)))this.cmd("backward_char")||(t=!0)}),forward_paragraph:Ymacs_Interactive_X(function(){this.cmd("forward_whitespace"),this.cmd("search_forward_regexp",this.getq("syntax_paragraph_sep"))?this.cmd("goto_char",this.cmd("match_beginning")+1):this.cmd("end_of_buffer")}),backward_paragraph:Ymacs_Interactive_X(function(){this.cmd("backward_whitespace"),this.cmd("search_backward_regexp",this.getq("syntax_paragraph_sep"))?this.cmd("goto_char",this.cmd("match_end")-1):this.cmd("beginning_of_buffer")}),transpose_words:Ymacs_Interactive_X(function(){var e;this.cmd("backward_char"),this.getq("syntax_word").test(this.charAt())&&this.cmd("forward_word"),e=[],this.cmd("forward_word"),e.push(this.point()),this.cmd("backward_word"),e.push(this.point()),this.cmd("backward_word"),e.push(this.point()),this.cmd("forward_word"),e.push(this.point()),this.cmd("goto_char",this._swapAreas(e))}),transpose_lines:Ymacs_Interactive_X(function(){var e=[];this.cmd("backward_line"),this.cmd("beginning_of_line"),e.push(this.point()),this.cmd("end_of_line"),e.push(this.point()),this.cmd("forward_char"),e.push(this.point()),this.cmd("end_of_line"),e.push(this.point()),this.cmd("goto_char",this._swapAreas(e)+1)}),transpose_chars:Ymacs_Interactive_X(function(){var e=this.point();this.cmd("backward_char")&&this.cmd("goto_char",this._swapAreas([e-1,e,e,e+1]))}),kill_word:Ymacs_Interactive_X(function(){var e,t=this.point();this.cmd("forward_word"),e=this.point(),this._killingAction(t,e,!1)}),backward_kill_word:Ymacs_Interactive_X(function(){var e,t=this.point();this.cmd("backward_word"),e=this.point(),this._killingAction(t,e,!0)}),_apply_operation_on_word:function(e,t){var n,r,i=this.point();this.getq("syntax_word").test(this.charAt())?(n=this.cmd("save_excursion",function(){return this.cmd("forward_word"),this.point()}),r=e.call(this._bufferSubstring(i,n)),this._deleteText(i,n),this._insertText(r)):(this.cmd("forward_word"),this.cmd("backward_word"),i!=this.point()&&this.cmd(t))},capitalize_word:Ymacs_Interactive_X(function(){this.cmd("_apply_operation_on_word",function(){return this.charAt(0).toUpperCase()+this.substr(1).toLowerCase()},"capitalize_word")}),downcase_word:Ymacs_Interactive_X(function(){this.cmd("_apply_operation_on_word",String.prototype.toLowerCase,"downcase_word")}),upcase_word:Ymacs_Interactive_X(function(){this.cmd("_apply_operation_on_word",String.prototype.toUpperCase,"upcase_word")}),goto_char:Ymacs_Interactive("NGoto char: ",function(e){return this._repositionCaret(e)}),goto_line:Ymacs_Interactive("NGoto line: ",function(e){var t=this._rowColToPosition(e-1,0);return this.cmd("goto_char",t)}),move_to_column:Ymacs_Interactive("NMove to column: ",function(e,t){var n=this._positionToRowCol(this.point()),r=this.code[n.row];r.length<e?t?(this.cmd("end_of_line"),this.cmd("insert"," ".x(e-r.length))):this.cmd("end_of_line"):this.cmd("goto_char",this._rowColToPosition(n.row,e))}),delete_region:Ymacs_Interactive("r",function(e,t){this._deleteText(e,t)}),insert:Ymacs_Interactive("sInsert text: ",function(){return this._insertText(Array.$(arguments).join(""))}),keyboard_quit:Ymacs_Interactive("^p",Function.noop),buffer_substring:function(e,t){var n;return arguments.length==0&&(n=this.getRegion(),e=n.begin,t=n.end),this._bufferSubstring(e,t)},kill_line:Ymacs_Interactive_X(function(){var e=this.point(),t=this._rowcol,n=this.code[t.row],r=e+n.length-t.col;t.row<this.code.length-1&&this.cmd("looking_at",/\s*$/mg)&&r++,this._killingAction(e,r)}),save_excursion:function(){return this._saveExcursion.apply(this,arguments)},prevent_undo:function(){return this._disableUndo.apply(this,arguments)},point:function(){return this.caretMarker.getPosition()},kill_region:Ymacs_Interactive("r",function(e,t){this._killingAction(e,t)}),copy_region_as_kill:Ymacs_Interactive("r",function(e,t){this._killingAction(e,t,!1,!0)}),yank:Ymacs_Interactive("^P",function(e){var t;this.deleteTransientRegion(),t=this.point(),this._insertText(this.ymacs.killRingText()),this.cmd("set_mark_command",t),e&&this.cmd("exchange_point_and_mark")}),yank_pop:Ymacs_Interactive(function(){/^yank/.test(this.previousCommand)?(this.ymacs.rotateKillRing(!1),this._deleteText(this.caretMarker,this.markMarker),this.cmd("yank")):this.signalError("Previous command was not a yank")}),yank_shift:Ymacs_Interactive(function(){/^yank/.test(this.previousCommand)?(this.ymacs.rotateKillRing(!0),this._deleteText(this.caretMarker,this.markMarker),this.cmd("yank")):this.signalError("Previous command was not a yank")}),mark:function(){return this.markMarker.getPosition()},set_mark_command:Ymacs_Interactive("d",function(e){this.currentCommand=="set_mark_command"&&this.signalInfo("Mark set",null,1e3),this.markMarker.setPosition(e)}),exchange_point_and_mark:Ymacs_Interactive("^",function(){this.caretMarker.swap(this.markMarker)}),mark_whole_buffer:Ymacs_Interactive(function(){this.clearTransientMark(),this.cmd("end_of_buffer"),this.ensureTransientMark(),this.cmd("beginning_of_buffer"),this.ensureTransientMark()}),recenter_top_bottom:Ymacs_Interactive(function(){this.whenActiveFrame(function(e){e.centerOnCaret()})}),ensure_caret_visible:Ymacs_Interactive(function(){this.whenActiveFrame(function(e){e.ensureCaretVisible()&&e.centerOnCaret()})}),fill_paragraph:Ymacs_Interactive("P",function(e){this.cmd("save_excursion",function(){var t,n,r,i;this.cmd("looking_at",this.getq("syntax_paragraph_sep"))||this.cmd("forward_paragraph"),t=this.createMarker(this.point()-1),this.cmd("backward_paragraph"),this.point()>0&&this.cmd("forward_char"),n="",r=!1,this.cmd("looking_at",/\s*([-]|[0-9]+\.|\(?[a-z][\).])?\s+/ig)?(n=" ".x(this.matchData[0].length),r=/\s*[#>;\s]*\s*/g):this.cmd("looking_at",/\s*[#>;*\s]+\s*/g)&&(n=this.matchData[0],r=/\s*[#>;\s]*\s*/g),e&&(this._deleteText(this.point(),this.point()+this.matchData[0].length),n="");for(;;){this.cmd("end_of_line"),this.cmd("backward_delete_whitespace");if(this.point()>=t.getPosition())break;this._replaceText(this.point(),this.point()+1," "),r&&this.cmd("looking_at",r)&&this._deleteText(this.point(),this.point()+this.matchData[0].length)}this.cmd("beginning_of_line");while(this.point()<t.getPosition()){i=this.point();if(!this.cmd("search_forward_regexp",/\s/g))break;this.point()>t.getPosition()&&this.cmd("goto_char",t),this._rowcol.col>this.getq("fill_column")&&(this.cmd("goto_char",i),this.cmd("backward_delete_whitespace"),this.cmd("newline"),this.cmd("insert",n))}t.destroy(),this.cmd("recenter_top_bottom")})}),fill_paragraph_no_prefix:Ymacs_Interactive(function(){return this.cmd("fill_paragraph",!0)}),start_next_paragraph:Ymacs_Interactive(function(){var e;this.cmd("backward_paragraph"),this.point()>0&&this.cmd("forward_char"),e="",this.cmd("looking_at",/(\s*)([0-9]+)(\.\s+)/g)?e=this.matchData[1]+(parseInt(this.matchData[2],10)+1)+this.matchData[3]:this.cmd("looking_at",/(\s*\(?)([a-z])([\.\)]\s+)/ig)?e=this.matchData[1]+String.fromCharCode(this.matchData[2].charCodeAt(0)+1)+this.matchData[3]:this.cmd("looking_at",/\s*[#>;*\s-]+\s*/g)&&(e=this.matchData[0]),this.cmd("forward_paragraph"),this.cmd("eob_p")&&this.cmd("newline"),this.cmd("insert","\n",e),this.cmd("looking_at",/\n\n/g)||(this.cmd("newline"),this.cmd("backward_char"))}),scroll_down_half:Ymacs_Interactive_X(function(){this.whenActiveFrame(function(e){var t=e.heightInLines();this.cmd("forward_line",Math.round(t/1.33)),this.cmd("recenter_top_bottom")})}),scroll_up_half:Ymacs_Interactive_X(function(){this.whenActiveFrame(function(e){var t=e.heightInLines();this.cmd("backward_line",Math.round(t/1.33)),this.cmd("recenter_top_bottom")})}),scroll_up:Ymacs_Interactive("p",function(e){e==null&&(e=3),this.whenActiveFrame(function(t){t.scrollUp(e)})}),scroll_down:Ymacs_Interactive("p",function(e){e==null&&(e=3),this.whenActiveFrame(function(t){t.scrollDown(e)})}),nuke_trailing_whitespace:Ymacs_Interactive(function(){this.cmd("save_excursion",function(){var e,t;this.cmd("goto_char",0);while(this._rowcol.row<this.code.length){e=this.code[this._rowcol.row],t=/\s+$/.exec(e),t&&(this.cmd("beginning_of_line"),this._deleteText(this.point()+t.index,this.point()+e.length));if(!this.cmd("forward_line"))break}})}),match_string:function(e){return this.matchData[e]},match_beginning:function(){return this.matchData.index},match_end:function(){return this.matchData.index+this.matchData[0].length},undo:Ymacs_Interactive_X(function(){var e=this.__undoQueue;this.__undoQueue=this.__redoQueue,this._placeUndoBoundary(),this._playbackUndo(e)||this.signalError("No further undo information"),this.__undoQueue=e}),center_line:Ymacs_Interactive("p",function(e){e==null&&(e=1),e.times(function(e){e>0&&this.cmd("forward_line"),this.cmd("save_excursion",function(){var e,t;this.cmd("end_of_line"),this.cmd("backward_delete_whitespace",!0),this.cmd("beginning_of_line"),this.cmd("delete_whitespace",!0),e=this.code[this._rowcol.row],t=Math.floor((this.getq("fill_column")-e.length)/2),this.cmd("insert"," ".x(t))})},this)}),dabbrev_expand:Ymacs_Interactive_X(function(){var e,t,n;this.previousCommand!="dabbrev_expand"&&this.setq("dabbrev_context",null),e=this.getq("dabbrev_context");if(!e){e=this.setq("dabbrev_context",{}),t=this.cmd("save_excursion",function(){return this.cmd("bind_variables",{syntax_word:this.getq("syntax_word_dabbrev")},"backward_word"),this.point()});if(t==this.point())return this.signalError("Nothing to expand");e.search=this.cmd("buffer_substring",t,this.point()),e.point=t,e.length=this.point()-t,e.lastSearch=t,e.encountered={},e.forward=!1,e.buffer=this,e.startBuffer=this}e.buffer.cmd("save_excursion",function r(){var t,i=this.getq("syntax_word_dabbrev"),s=!1;this.cmd("goto_char",e.lastSearch);if(!e.forward){while(this.cmd("search_backward",e.search))if(!i.test(this.charAt(-1))){s=!0;break}if(!s){e.forward=!0,e.lastSearch=e.point+e.length,r.call(this);return}t=this.point(),e.lastSearch=t,this.cmd("goto_char",t+e.search.length)}else{while(this.cmd("search_forward",e.search))if(!i.test(this.charAt(-e.search.length-1))){s=!0;break}if(!s){e.buffer=this.whenYmacs("getNextBuffer",this);if(e.buffer===e.startBuffer){n=e.search,e.startBuffer.signalError("No more completions"),e.lastSearch=e.point+e.length,e.startBuffer.setq("dabbrev_context",null);return}e.lastSearch=0,e.buffer.cmd("save_excursion",r);return}e.lastSearch=this.point(),t=this.point()-e.search.length}t!=null&&(this.cmd("bind_variables",{syntax_word:this.getq("syntax_word_dabbrev")},"forward_word"),n=this.cmd("buffer_substring",t,this.point()),Object.HOP(e.encountered,n)&&r.call(this))}),n!=null&&(this._replaceText(e.point,e.point+e.length,n),e.length=n.length,e.encountered[n]=!0)}),split_frame_vertically:Ymacs_Interactive("p",function(e){e==null?e="50%":e+="%",this.whenActiveFrame("vsplit",e)}),split_frame_horizontally:Ymacs_Interactive("p",function(e){e==null?e="50%":e+="%",this.whenActiveFrame("hsplit",e)}),delete_other_frames:Ymacs_Interactive(function(){this.whenActiveFrame("deleteOtherFrames")}),delete_frame:Ymacs_Interactive(function(){this.whenActiveFrame("deleteFrame")}),other_frame:Ymacs_Interactive(function(){this.whenYmacs("focusOtherFrame")}),windmove:function(e){this.whenYmacs(function(t){var n=t.getFrameInDirection(e);n&&n.focus()})},next_buffer:Ymacs_Interactive(function(){this.whenYmacs("switchToNextBuffer",this.sameCommandCount()+1)}),previous_buffer:Ymacs_Interactive(function(){this.whenYmacs("switchToPreviousBuffer",this.sameCommandCount()+1)}),switch_to_buffer:Ymacs_Interactive("BSwitch to buffer: ",function(e){this.whenYmacs(function(t){t.switchToBuffer(e)})}),kill_buffer:Ymacs_Interactive(function(){this.whenYmacs(function(e){e.killBuffer(this)})}),rename_buffer:Ymacs_Interactive("sRename current buffer to: ",function(e){this.whenYmacs(function(t){t.renameBuffer(this,e)})}),delete_region_or_line:Ymacs_Interactive("^",function(){var e;if(!this.deleteTransientRegion()){this.cmd("beginning_of_line"),e=this.point();if(this.cmd("forward_line")||this.cmd("end_of_line"))return this._deleteText(e,this.point()),!0}}),close_last_xml_tag:Ymacs_Interactive_X(function(){var e;this.cmd("save_excursion",function(){var t=1;while(t!=0&&this.cmd("search_backward_regexp",/<\x2f?([a-zA-Z0-9:_-]+)/g))e=this.cmd("match_string",1),this.cmd("looking_at",/<\x2f/g)?++t:this.cmd("looking_at",/<[^\x2f][^>]*?\x2f>/g)||--t;t!=0&&(e=null)});if(!e)throw new Ymacs_Exception("Couldn't find a tag to close");this.cmd("insert","</",e,">")}),bind_variables:function(){return this.withVariables.apply(this,arguments)},for_region:Ymacs_Interactive("^r\nCExecute command within region: ",function(e,t,n){var r;t<e&&(r=e,e=t,t=r),n instanceof Function||(n=this.COMMANDS[n]),this.clearTransientMark(),this.cmd("goto_char",e),e=this.createMarker(e,!0),t=this.createMarker(t),this.withCommands({goto_char:function(n){if(n<e.getPosition()||n>t.getPosition())throw"YMACS_RESTRICT";return this._repositionCaret(n)}},function(){var r;try{for(;;){r=this.point(),n.call(this);if(this.point()==r&&!this.cmd("forward_line"))break}}catch(i){if(i!=="YMACS_RESTRICT")throw i}finally{e.destroy(),t.destroy
()}})}),get_line_comment_syntax:function(){var e=this.getq("syntax_comment_line");if(!e)throw new Ymacs_Exception("Unknown comment syntax");return e},comment_region:Ymacs_Interactive("^r",function(e,t){var n=this.cmd("get_line_comment_syntax");this.clearTransientMark(),this.cmd("save_excursion",function(){var r,i;t=this.createMarker(t),this.cmd("goto_char",e),r=1e5;e:while(this.point()<t.getPosition()){while(this.cmd("looking_at",/\s*$/mg))if(!this.cmd("forward_line"))break e;i=this._rowcol.col;while(this.cmd("looking_at",/\s/g)&&i<r){if(!this.cmd("forward_char"))break e;++i}i<r&&(r=i),this.cmd("insert",n.ch," "),this.cmd("beginning_of_line");if(!this.cmd("forward_line"))break e}this.cmd("goto_char",t),this._rowcol.col>0&&!this.cmd("looking_at",/\s*$/mg)&&this.cmd("newline_and_indent")})}),uncomment_region:Ymacs_Interactive("r",function(e,t){var n=this.cmd("get_line_comment_syntax");this.clearTransientMark(),this.cmd("save_excursion",function(){t=this.createMarker(t),this.cmd("goto_char",e);while(this.point()<t.getPosition()){this.cmd("forward_whitespace"),this.cmd("looking_at",n.rx)&&this.cmd("delete_char",this.matchData[0].length);if(!this.cmd("forward_line"))break}})}),comment_dwim:Ymacs_Interactive("^r",function(e,t){var n=this.cmd("get_line_comment_syntax");this.transientMarker?this.cmd("save_excursion",function(){var r;this.cmd("goto_char",e),r=this.cmd("looking_at",n.rx),r?this.cmd("uncomment_region",e,t):this.cmd("comment_region",e,t)}):(this.cmd("end_of_line"),this.cmd("insert"," ",n.ch," "),this.cmd("indent_line"))})}),function(){function e(e,t,n,r){e.cmd("save_excursion",function(){var e,i,s,o,u,a,f,l=this._positionToRowCol(t),c=this._positionToRowCol(n),h=Math.abs(c.col-l.col);for(e=l.row;e<=c.row;++e)this.cmd("goto_char",this._rowColToPosition(e,0)),i=this.code[e],s=l.col,o=c.col,u=this.point(),a=0,s>o&&(f=s,s=o,o=f),s>i.length&&(a=s-i.length,s=i.length),o>i.length&&(o=i.length),r.call(this,u+s,u+o,a,h)},t==e.point())}Ymacs_Buffer.newCommands({string_rectangle:Ymacs_Interactive("r\nsString rectangle: ",function(t,n,r){e(this,t,n,function(e,t,n){n>0?this._insertText(" ".x(n),e):this._deleteText(e,t),this._insertText(r,e+n)})}),kill_rectangle:Ymacs_Interactive("r",function(t,n){var r=[];e(this,t,n,function(e,t,n,i){var s=this._bufferSubstring(e,t);t-e<i&&(s+=" ".x(i-t+e)),r.push(s),this._deleteText(e,t)}),this.setq("killed_rectangle",r)}),clear_rectangle:Ymacs_Interactive("r",function(e,t){this.cmd("string_rectangle",e,t," ".x(Math.abs(this._positionToRowCol(t).col-this._positionToRowCol(e).col)))}),insert_rectangle:function(e,t){var n=this._positionToRowCol(e).col;this.cmd("set_mark_command",e),t.foreach(function(e,t){t>0&&(this.cmd("forward_line")||(this.cmd("end_of_line"),this.cmd("newline")),this.cmd("move_to_column",n,!0)),this.cmd("insert",e)},this)},yank_rectangle:Ymacs_Interactive("d",function(e){var t=this.getq("killed_rectangle");if(t==null)throw new Ymacs_Exception("No killed rectangle");this.cmd("insert_rectangle",e,t)})})}(),function(){function e(e,t,n,r,i){var s=e.createDialog({title:n,quitBtn:"destroy",modal:!0}),o=new DlLayout({parent:s,outerSpace:5}),u=new DlEntry({type:"textarea",fillParent:!0,value:r});s._focusedWidget=u,t=="copy"?u.addEventListener("onCopy",function(){s.destroy(),i()}.clearingTimeout(0)):t=="paste"&&u.addEventListener("onPaste",function(){var e=u.getValue();s.destroy(),i(e)}.clearingTimeout(0)),o.packWidget(u,{pos:"top",fill:"*"}),o.setSize({x:350,y:250}),s.show(!0),u.select()}Ymacs_Buffer.newCommands({yank_from_operating_system:Ymacs_Interactive(function(){var t=this;e(t,"paste","Paste below (press CTRL-V)",null,function(e){t._saveKilledText(e),t.cmd("yank"),t.cmd("recenter_top_bottom")})}),copy_for_operating_system:Ymacs_Interactive("r",function(t,n){var r=this;e(r,"copy","Press CTRL-C to copy",r.cmd("buffer_substring"),function(){r.cmd("copy_region_as_kill",t,n)})})})}(),["forward_char","forward_word","forward_line","forward_paragraph","forward_sexp","beginning_of_line","beginning_of_indentation_or_line","beginning_of_buffer","backward_char","backward_word","backward_line","backward_paragraph","backward_sexp","end_of_line","end_of_buffer"].foreach(function(e){Ymacs_Buffer.COMMANDS[e+"_mark"]=Ymacs_Interactive("^",function(){this.ensureTransientMark(),this.cmdApply(e,arguments),this.ensureTransientMark()})}),Ymacs_Buffer.newCommands({get_region:function(){return this.getRegion()},figure_out_mode:function(e){var t=e.split(/\n/);return t.length>4&&t.splice(2,t.length-4),t.foreach(function(e,t){(t=/-\*-\s*(.*?)\s*-\*-/i.exec(e))&&$RETURN(t[1])})},cperl_lineup:Ymacs_Interactive("r",function(e,t){this.cmd("save_excursion",function(){var n,r,i=this._positionToRowCol(t),s=0,o=[];this.cmd("goto_char",e),this.cmd("forward_whitespace",!0),n=this.charAt();if(n.toLowerCase()!=n.toUpperCase()){this.signalError("Cannot lineup here");return}while(this._rowcol.row<=i.row){r=this.getLine().indexOf(n),r>=0&&(r>s&&(s=r),o.push([this._rowcol.row,r]));if(!this.cmd("forward_line"))break}++s,o.foreach(function(e){this.cmd("goto_char",this._rowColToPosition(e[0],e[1])),this.cmd("insert"," ".x(s-e[1]))},this)})}),htmlize_region:Ymacs_Interactive("r\nP",function(e,t,n){var r,i,s,o,u;this.tokenizer.finishParsing(),r=this._positionToRowCol(e).row,i=String.buffer(),s=r,n&&!n.empty&&(s=parseInt(n,10)),t=this._positionToRowCol(t).row,o=(t+"").length;while(r<=t)i("<div class='line'>"),n&&i("<span class='line-number'>",s.zeroPad(o," "),"</span>"),++s,i(this._textProperties.getLineHTML(r,this.code[r],null),"</div>\n"),++r;i=i.get(),u=this.ymacs.switchToBuffer("*Htmlize*"),u.setCode(i),u.cmd("xml_mode",!0)}),execute_extended_command:Ymacs_Interactive("^CM-x ",function(e){this.callInteractively(e)}),set_variable:Ymacs_Interactive("vSet variable: \nsTo value: ",function(e,t){var n=parseFloat(t);isNaN(n)||(t=n),this.setq(e,t)}),eval_string:Ymacs_Interactive("^MEval string: ",function(e){var t;try{t=[this,this.ymacs],e=Function("buffer","ymacs",e),e.apply(this,t),this.clearTransientMark()}catch(n){this.signalError(n.type+": "+n.message),window.console&&console.log(n)}}),eval_region:Ymacs_Interactive("^r",function(e,t){this.cmd("eval_string",this.cmd("buffer_substring",e,t))}),eval_buffer:Ymacs_Interactive(function(){this.cmd("eval_string",this.getCode())}),toggle_line_numbers:Ymacs_Interactive("^",function(){this.whenActiveFrame("toggleLineNumbers")}),save_file:Ymacs_Interactive("FWrite file: ",function(e){this.ymacs.ls_setFileContents(e,this.getCode()),this.signalInfo("Saved in local storage")}),load_file:Ymacs_Interactive("fFind file: ",function(e){var t,n=this.ymacs.ls_getFileContents(e),r=this.ymacs.createBuffer({name:e});r.setCode(n),this.cmd("switch_to_buffer",e),t=this.cmd("figure_out_mode",n),t&&(Object.HOP(r.COMMANDS,t)?r.cmd(t):Object.HOP(r.COMMANDS,t+"_mode")&&r.cmd(t+"_mode"))}),delete_file:Ymacs_Interactive("fDelete file: ",function(e){var t;this.ymacs.ls_getFileContents(e),t=this.ymacs.ls_get(),delete t[e],this.ymacs.ls_set(t)}),eval_file:Ymacs_Interactive("fEval file: ",function(e){this.cmd("eval_string",this.ymacs.ls_getFileContents(e))})}),DEFINE_CLASS("Ymacs_Keymap",null,function(e,t){var n={};Object.foreach(DlKeyboard,function(e,t){typeof e=="number"&&(n[e]=t)}),e.CONSTRUCT=function(){this.definitions=Object.makeCopy(this.__originalDefs)},t.FINISH_OBJECT_DEF=function(){var e;this.__originalDefs={},e=this.constructor.KEYS,e&&this.defineKeys(e)},t.parseKey=function(e){var t,n={},r=e.split(/-/);return r.reverse(),r.foreach(function(e,t){if(t==0)e=="WHEEL_UP"||e=="WHEEL_DOWN"?n.charCode=e:typeof DlKeyboard[e]=="number"?n.keyCode=DlKeyboard[e]:(r[t]=e.toLowerCase(),n.charCode=r[t].charCodeAt(0));else switch(e){case"C":n.ctrlKey=!0;break;case"M":n.metaKey=!0;break;case"S":n.shiftKey=!0}}),r.reverse(),t=r.pop(),n.str=r.sort().join("-"),n.str&&(n.str+="-"),n.str+=t,n},e.unparseKey=function(e){var t,r=[];return"wheelDelta"in e?t=e.wheelDelta>0?"WHEEL_UP":"WHEEL_DOWN":e.keyCode in n?t=n[e.keyCode]:e.charCode&&(e.charCode==32?t="SPACE":e.charCode==45?t="DASH":t=String.fromCharCode(e.charCode).toLowerCase()),e.ctrlKey&&r.push("C"),e.altKey&&r.push("M"),e.shiftKey&&(e.charCode&&/^[a-zA-Z0-9]$/.test(t)||e.keyCode)&&r.push("S"),r.sort(),r=r.join("-"),r&&(r+="-"),r+t},t.defineKey=function(e,t,n){var r,i;t instanceof Array&&(n=t.slice(1),t=t[0]),e=e.trim().split(/\s*&&\s*/),e.length>1?e.foreach(function(e){this.defineKey(e,t,n)},this):(e=e[0].trim(),r=this.definitions||this.__originalDefs,e.indexOf(" ")>=0&&(i=e.split(/\s+/),e=i.pop(),i.foreach(function(e){e=this.parseKey(e).str,r[e]||(r[e]={}),r=r[e]},this)),e=this.parseKey(e),r[e.str]=[t,n])},t.defineKeys=function(e){Object.foreach(e,function(e,t){this.defineKey(t,e)},this)},t.getHandler=function(e){var t=null,n=this.definitions;return e.foreach(function(e){var r=t?t[e]:n[e];r?(t=r,t instanceof Array&&$BREAK()):t&&(t=null,$BREAK())}),t},t.attached=Function.noop,t.detached=Function.noop}),DEFINE_SINGLETON("Ymacs_Keymap_Emacs",Ymacs_Keymap,function(e,t){var n=String.template("<table>","<tr><td style='text-align: right; font-weight: bold'>Char:</td><td><tt> $ch </tt></td></tr>","<tr><td style='text-align: right; font-weight: bold'>Char code:</td><td> $code / 0x$codeHex </td></tr>","<tr><td style='text-align: right; font-weight: bold'>Position:</td><td> $point </td></tr>","<tr><td style='text-align: right; font-weight: bold'>Mark:</td><td> $mark </td></tr>","<tr><td style='text-align: right; font-weight: bold'>Buffer size:</td><td> $sizeKB </td></tr>","</table>");e.KEYS={"ARROW_UP     && C-p":"backward_line","ARROW_DOWN   && C-n":"forward_line","ARROW_LEFT   && C-b":"backward_char","ARROW_RIGHT  && C-f":"forward_char",HOME:"beginning_of_indentation_or_line","END && C-e":"end_of_line","C-a":"beginning_of_line","C-HOME && M-<":"beginning_of_buffer","C-END && M->":"end_of_buffer","C-ARROW_RIGHT && M-f":"forward_word","C-ARROW_LEFT && M-b":"backward_word","C-ARROW_DOWN":"forward_paragraph","C-ARROW_UP":"backward_paragraph","C-l":"recenter_top_bottom","PAGE_UP && M-v":"scroll_up_half","PAGE_DOWN && C-v":"scroll_down_half",WHEEL_UP:"scroll_up",WHEEL_DOWN:"scroll_down","S-ARROW_UP       && S-C-p":"backward_line_mark","S-ARROW_DOWN     && S-C-n":"forward_line_mark","S-ARROW_LEFT     && S-C-b":"backward_char_mark","S-ARROW_RIGHT    && S-C-f":"forward_char_mark","S-C-ARROW_RIGHT  && S-M-f":"forward_word_mark","S-C-ARROW_LEFT   && S-M-b":"backward_word_mark","S-C-ARROW_DOWN":"forward_paragraph_mark","S-C-ARROW_UP":"backward_paragraph_mark","S-HOME":"beginning_of_indentation_or_line_mark","S-C-a":"beginning_of_line_mark","S-END":"end_of_line_mark","S-C-HOME":"beginning_of_buffer_mark","S-C-END":"end_of_buffer_mark",BACKSPACE:"backward_delete_char","DELETE && C-d":"delete_char","ENTER && C-m":"newline","M-d && C-DELETE":"kill_word","C-BACKSPACE && M-BACKSPACE && M-DELETE":"backward_kill_word","C-k":"kill_line","C-y && S-INSERT":"yank","M-y":"yank_pop","C-SPACE":"set_mark_command","C-x C-x":"exchange_point_and_mark","C-w":"kill_region","M-t":"transpose_words","C-t":"transpose_chars","C-x C-t":"transpose_lines","M-w":"copy_region_as_kill","M-c":"capitalize_word","M-u":"upcase_word","M-l":"downcase_word",F11:"nuke_trailing_whitespace",TAB:"indent_line","C-M-\\":"indent_region","M-q":"fill_paragraph","C-/ && C-x u && C-_ && C-z":"undo",INSERT:"overwrite_mode","M-s":"center_line","M-/":"dabbrev_expand","C-s":"isearch_forward","C-r":"isearch_backward","M-C-s":"isearch_forward_regexp","M-C-r":"isearch_backward_regexp","C-u":"universal_argument","M-g":"goto_line","C-x h":"mark_whole_buffer","C-g":"keyboard_quit","M-^":"delete_indentation","M-;":"comment_dwim","C-x r t":"string_rectangle","C-x r c":"clear_rectangle","C-x r k":"kill_rectangle","C-x r y":"yank_rectangle","C-x C-ARROW_RIGHT && C-x ARROW_RIGHT && C-TAB":"next_buffer","C-x C-ARROW_LEFT && C-x ARROW_LEFT && C-S-TAB":"previous_buffer","C-x b":"switch_to_buffer","C-x k":"kill_buffer","C-x 0":"delete_frame","C-x 1":"delete_other_frames","C-x 2":"split_frame_vertically","C-x 3":"split_frame_horizontally","C-x o":"other_frame","C-x l":"toggle_line_numbers","M-x":"execute_extended_command","C-S-y":"yank_from_operating_system","M-S-w":"copy_for_operating_system","M-S-y":"yank_shift","C-c /":"close_last_xml_tag","S-BACKSPACE":"backward_delete_whitespace","S-DELETE":"delete_whitespace","C-M-d":"delete_region_or_line","M-ENTER":"start_next_paragraph","M-S-q":"fill_paragraph_no_prefix","C-M-|":"cperl_lineup","C-F4":"kill_buffer","M-ARROW_LEFT":["windmove","left"],"M-ARROW_RIGHT":["windmove","right"],"M-ARROW_UP":["windmove","up"],"M-ARROW_DOWN":["windmove","down"],"C-x =":function(){var e=this.charAt(),t=e;e==" "?t="<SPACE>":e=="\n"?t="<NEWLINE>":e=="-"&&(t="<DASH>"),this.signalInfo(n({ch:t.htmlEscape(),code:e.charCodeAt(0),codeHex:e.charCodeAt().hex(),point:this.point(),mark:this.markMarker.getPosition(),size:this.getCodeSize(),sizeKB:this.getCodeSize().formatBytes(2)}),!0)}},t.defaultHandler=["self_insert_command"]}),DEFINE_SINGLETON("Ymacs_Keymap_UniversalArgument",Ymacs_Keymap,function(e,t){t.defaultHandler=[Ymacs_Interactive("^",function(){var e=this.interactiveEvent(),t=String.fromCharCode(e.charCode),n=this.getPrefixArg(!0);return e.charCode&&(/^[0-9]$/.test(t)||t==="-"&&n==="")&&!e.altKey&&!e.ctrlKey?(n+=t,this.setPrefixArg(n),this.isMinibuffer||this.whenMinibuffer(function(e){e.cmd("insert"," ",t)}),!0):(this.popKeymap(Ymacs_Keymap_UniversalArgument()),!1)})],t.attached=function(e){e.setPrefixArg("")}}),DEFINE_SINGLETON("Ymacs_Keymap_ISearch",Ymacs_Keymap,function(e){function t(e){if(!this._isearchContext)return this.pushKeymap(Ymacs_Keymap_ISearch()),this.cmd("set_mark_command",this.point()),this.setMinibuffer(e?"I-Search: ":"I-Search backward: "),this._isearchContext={forward:e,point:this.point(),mbMark:this.getMinibuffer().createMarker(null,!0)},!0}function n(e){var t;return this._isearchContext.forward=e,this._isearchContext.point=this.point(),t=i(this),!/\S/.test(t)&&this.getq("isearch_last_text")&&(this.getMinibuffer()._placeUndoBoundary(),this.getMinibuffer().cmd("insert",this.getq("isearch_last_text")),t=this.getq("isearch_last_text")),r.call(this,t)}function r(e){var t,n;return e==null&&(e=i(this)),t=this.cmd("bind_variables",{case_fold_search:e==e.toLowerCase()},this.cmd,this._isearchContext.forward?"search_forward":"search_backward",e),t&&(this.cmd("ensure_caret_visible"),n=this._positionToRowCol(this.point()+(this._isearchContext.forward?-1:1)*e.length),this.setOverlay("isearch",{line1:n.row,line2:this._rowcol.row,col1:n.col,col2:this._rowcol.col})),t}function i(e){return e.cmd("isearch_get_search_text")}e.KEYS={"C-g && ESCAPE":["isearch_abort",!0],"C-w":"isearch_yank_word_or_char","C-s":"isearch_forward","C-r":"isearch_backward",BACKSPACE:function(){this.getMinibuffer().point()>this._isearchContext.mbMark.getPosition()&&(this.getMinibuffer().cmd("backward_delete_char"),this.cmd("goto_char",this._isearchContext.point),n.call(this,this._isearchContext.forward))},ENTER:"isearch_abort"},e.CONSTRUCT=function(){this.defaultHandler=["isearch_printing_char"]},Ymacs_Buffer.newCommands({isearch_get_search_text:Ymacs_Interactive(function(){if(this._isearchContext)return this.getMinibuffer()._bufferSubstring(this._isearchContext.mbMark)}),isearch_forward:Ymacs_Interactive(function(){t.call(this,!0)||n.call(this,!0)||this.signalError("No more forward occurrences of the search text")}),isearch_forward_regexp:Ymacs_Interactive(function(){this.signalError("Not implemented, but should be easy.  Volunteers?")}),isearch_backward_regexp:Ymacs_Interactive(function(){this.signalError("Not implemented, but should be easy.  Volunteers?")}),isearch_backward:Ymacs_Interactive(function(){t.call(this,!1)||n.call(this,!1)||this.signalError("No more backward occurrences of the search text")}),isearch_yank_word_or_char:Ymacs_Interactive(function(){var e,t=this.point(),n=this.cmd("save_excursion",function(){return this.cmd("forward_word"),this.point()});n!=t&&(e=this._bufferSubstring(t,n),this.getMinibuffer()._placeUndoBoundary(),this.getMinibuffer().cmd("insert",e.toLowerCase()),e=i(this),this._isearchContext.forward&&this.cmd("goto_char",n-e.length),r.call(this,e))}),isearch_printing_char:Ymacs_Interactive(function(){var e=this.interactiveEvent();if(e.charCode&&!e.ctrlKey&&!e.altKey)return this.getMinibuffer().cmd("self_insert_command"),this.cmd("goto_char",this._isearchContext.point),r.call(this,i(this)),e.domStop=!0;if(e.keyCode!=0||e.ctrlKey||e.altKey)return this.cmd("isearch_abort"),!1}),isearch_abort:Ymacs_Interactive(function(e){return e||this.setGlobal("isearch_last_text",i(this)),this.setMinibuffer(""),this.popKeymap(Ymacs_Keymap_ISearch()),this._isearchContext.mbMark.destroy(),this._isearchContext=null,e&&this.cmd("exchange_point_and_mark"),this.deleteOverlay("isearch"),this.deleteOverlay("isearch-lazy"),!0})})}),Ymacs_Buffer.newMode("minibuffer_mode",function(){var e=this.createMarker(0,!0),t=this.setq({minibuffer_end_marker:e}),n=Ymacs_Keymap_Minibuffer();return this.pushKeymap(n),function(){this.setq(t),e.destroy(),this.popKeymap(n)}}),function(){function r(r,i){var s;t&&t.destroy(),t=new DlVMenu({}),i.foreach(function(e){var n=e;typeof e!="string"&&(n=e.completion,e=e.label),new DlMenuItem({parent:t,label:e.htmlEscape(),data:n})}),s=Ymacs_Completion_Popup.get(),s.popup({timeout:0,content:t,align:{prefer:"Tr",fallX1:"_r",fallX2:"_L",fallY1:"B_",fallY2:"T_"},anchor:r.getCaretElement(),widget:r,onHide:function(){e=!1,n=null,t=null},isContext:!0}),e=!0}function i(e,t,n){this.whenMinibuffer(function(r){var i=r.setq({completion_list:e,minibuffer_validation:function(e){return e==null&&(e=r.cmd("minibuffer_contents")),n?n.call(this,r,e):!0}.$(this),minibuffer_continuation:function(e){r.setq(i),t&&t.call(this,e)}.$(this)})})}function s(e,t){var n,i,s,o=this.ymacs.ls_getFileDirectory(t),u=o.dir,a=o.other,f=o.path,l=a[0];if(a.length!=1)throw new Ymacs_Exception("Not found");if(typeof u[l]=="string")return[f.concat([l]).join("/")];n=[];for(i in u)i.indexOf(l)==0&&n.push(i);s=n.common_prefix();if(s!=l)n.length==1&&typeof u[s]!="string"&&(s+="/"),e.cmd("minibuffer_replace_input",f.concat([s]).join("/"));else{if(n.length==1)throw new Ymacs_Exception("Single completion");if(n.length==0)throw new Ymacs_Exception("No completions");n=n.map(function(e){return typeof u[e]!="string"&&(e+="/"),{label:e,completion:f.concat([e]).join("/")}}),r(this.getMinibufferFrame(),n)}return null}function o(e){var r,i=n;switch(e){case"next":n==null&&(n=-1),n=t.children().rotateIndex(++n);break;case"prev":n==null&&(n=0),n=t.children().rotateIndex(--n)}i!=null&&(r=t.children(i),r.callHooks("onMouseLeave")),i=n,r=t.children(n),r.callHooks("onMouseEnter")}function u(){if(e)return o.call(this,"next")}function a(){if(e)return o.call(this,"prev")}function f(){e?n!=null?(this.cmd("minibuffer_replace_input",t.children()[n].userData),DlPopup.clearAllPopups()):this.signalError("Select something..."):this.cmd("minibuffer_complete_and_exit")}function l(){e||this.cmd("minibuffer_complete"),u.call(this)}function c(){a.call(this)}function h(){e?DlPopup.clearAllPopups():this.cmd("minibuffer_keyboard_quit")}var e=!1,t=null,n=null;Ymacs_Buffer.newCommands({minibuffer_prompt:function(e,t){this.whenMinibuffer(function(n){var r=this.getMinibufferFrame();n.setCode(""),n.cmd("prevent_undo",function(){n.cmd("insert",e)}),n.getq("minibuffer_end_marker").setPosition(n.point()),r._redrawCaret(!0),t||r.focus()})},minibuffer_read_number:function(e){i.call(this,null,e,function(e,t){var n=parseInt(t,10);return isNaN(n)&&e.signalError("Please enter a number"),!isNaN(n)})},minibuffer_read_command:function(e){var t=Array.hashKeys(this.COMMANDS).grep(function(e){return this.COMMANDS[e].ymacsInteractive},this).sort();i.call(this,t,e,function(e,t){var n=this.COMMANDS[t],r=n&&n.ymacsInteractive;return r||e.signalError("No such command: "+t),r})},minibuffer_read_function:function(e){var t=Array.hashKeys(this.COMMANDS).sort();i.call(this,t,e,function(e,t){var n=this.COMMANDS[t],r=!!n;return r||e.signalError("No such function: "+t),r})},minibuffer_read_buffer:function(e){this.whenYmacs(function(t){var n=t.buffers.map("name");n.push(n.shift()),i.call(this,n,e),l.call(this)})},minibuffer_read_string:function(e,t){i.call(this,e,t)},minibuffer_read_variable:function(e){var t,n=this.globalVariables;Object.merge(n,this.variables),t=Array.hashKeys(n).grep(function(e){return!/^\*/.test(e)}).sort(),i.call(this,t,e)},minibuffer_read_existing_file:function(e){var t=this.ymacs.ls_getFileDirectory(this.name).path.join("/");t&&(t+="/"),this.cmd("minibuffer_replace_input",t),i.call(this,s,e,function(e,t){var n=this.ymacs.ls_getFileContents(t,!0);return n||e.signalError("No such file: "+t),n})},minibuffer_read_file:function(e){var t=this.ymacs.ls_getFileDirectory(this.name).path.join("/");t&&(t+="/"),i.call(this,s,e)},minibuffer_read_file_or_directory:function(e){var t=this.ymacs.ls_getFileDirectory(this.name).path.join("/");t&&(t+="/"),i.call(this,s,e)},minibuffer_read_directory:function(e){var t=this.ymacs.ls_getFileDirectory(this.name).path.join("/");t&&(t+="/"),i.call(this,s,e)},minibuffer_prompt_end:function(){return this.whenMinibuffer(function(e){return e.getq("minibuffer_end_marker").getPosition()})},minibuffer_contents:function(){return this.whenMinibuffer(function(e){return e._bufferSubstring(e.getq("minibuffer_end_marker"))})},minibuffer_replace_input:function(e){this.whenMinibuffer(function(t){t._replaceText(t.getq("minibuffer_end_marker"),t.getCodeSize(),e),this.getMinibufferFrame()._redrawCaret(!0)})},minibuffer_complete:function(){this.whenMinibuffer(function(e){var t,n=e.getq("completion_list"),i=e.cmd("minibuffer_contents"),s=i.replace(/([\[\]\(\)\{\}\.\*\+\?\|\\])/g,"\\$1").replace(/([_-])/g,"[^_-]*[_-]");s=RegExp("^"+s,"i");if(n instanceof Function){n=n.call(this,e,i,s);if(!n)return}else n&&n.length>0&&(n=n.grep(function(e){return s.test(e)}));!n||n.length==0?e.signalError("No completions"):(t=n.common_prefix(),t!=i?e.cmd("minibuffer_replace_input",t):n.length==1?e.signalError("Sole completion"):r(this.getMinibufferFrame(),n))})},minibuffer_complete_and_exit:function(){this.whenMinibuffer(function(e){e.getq("minibuffer_validation").call(e)&&e.cmd("minibuffer_keyboard_quit",this.getq("minibuffer_continuation"))})},minibuffer_keyboard_quit:function(e){this.whenMinibuffer(function(t){var n=this.cmd("minibuffer_contents");t.setCode(""),this.ymacs.getActiveFrame().focus(),function(t){e&&e.call(this,t),this.getPrefixArg()}.delayed(1,this,n)}),DlPopup.clearAllPopups()}}),DEFINE_SINGLETON("Ymacs_Keymap_Minibuffer",Ymacs_Keymap,function(e,t){e.KEYS={"C-g":"minibuffer_keyboard_quit",TAB:l,"S-TAB":c,ARROW_DOWN:u,ARROW_UP:a,ENTER:f,ESCAPE:h},t.defaultHandler=[function(){return DlPopup.clearAllPopups(),!1}]})}(),DEFINE_CLASS("Ymacs_Completion_Popup",DlCompletionPopup),DEFINE_CLASS("Ymacs_Stream",null,function(e,t){e.DEFAULT_ARGS={buffer:["buffer",null],line:["line",0],col:["col",0]},t.nextCol=function(){++this.col},t.prevCol=function(){--this.col},t.nextLine=function(){++this.line,this.col=0},t.prevLine=function(){--this.line,this.col=0},t.peek=function(e){return e==null&&(e=0),this.buffer.code[this.line].charAt(this.col+e)},t.next=function(){var e=this.peek();return this.nextCol(),this.col>=this.buffer.code[this.line].length&&this.nextLine(),e},t.get=function(){var e=this.peek();return this.nextCol(),e},t.lineText=function(e){return e==null&&(e=this.line),this.buffer.code[e]},t.lineIndentation=function(e){return/^\s*/.exec(this.lineText(e))[0].length},t.lookingAt=function(e){var t=this.buffer.code[this.line];return e instanceof RegExp?e.exec(t.substr(this.col)):t.substr(this.col,e.length)==e},t.textBefore=function(e){return e==null&&(e=this.buffer._rowColToPosition(this.line,this.col)),this.buffer.getCode().substr(0,e)},t.textAfter=function(e){return e==null&&(e=this.buffer._rowColToPosition(this.line,this.col)),this.buffer.getCode().substr(e)},t.substring=function(e,t){return this.buffer.getCode().substring(e,t)},t.substr=function(e,t){return this.buffer.getCode().substr(e,t)},t.eol=function(){return this.col==this.buffer.code[this.line].length},t.eof=function(){var e=this.buffer.code.length,t=this.line;return t>=e||t==e-1&&this.eol()},t.length=function(){return this.buffer.code.length},t.lineLength=function(e){return e==null&&(e=this.line),this.buffer.code[e].length},t.save=function(){return{buffer:this.buffer,line:this.line,col:this.col}},t.restore=function(e){this.buffer=e.buffer,this.line=e.line,this.col=e.col},t.checkStop=function(){if(this.eof())throw this.EOF;if(this.eol())throw this.EOL},t.EOL={},t.EOF={},t.skip_ws=function(){while(Ymacs_Simple_Stream.is_whitespace(this.peek()))this.next()}}),DEFINE_CLASS("Ymacs_Simple_Stream",null,function(e,t){e.DEFAULT_ARGS={buffer:["buffer",null],line:["line",0],col:["col",0],pos:["pos",null]},e.CONSTRUCT=function(){var e;this.pos==null?this.pos=this.buffer._rowColToPosition(this.line,this.col):(e=this.buffer._positionToRowCol(this.pos),this.line=e.row,this.col=e.col)},t.peek=function(){var e=this.buffer.code,t=e[this.line];return t==null?null:this.col==t.length?this.line==e.length-1?null:"\n":t.charAt(this.col)},t.next=function(){var e=this.peek();return++this.pos,++this.col,this.col>this.buffer.code[this.line].length&&(this.col=0,++this.line),e},t.read_while=function(e){var t="";while(e(this.peek()))t+=this.next();return t},t.is_whitespace=e.is_whitespace=function(e){switch(e){case" ":case"\n":case"	":case"\f":case"\u2028":case"\u2029":case" ":return!0}},t.skip_ws=function(){return this.read_while(this.is_whitespace)},t.looking_at=function(e){var t=this.buffer.code[this.line];return e instanceof RegExp?e.exec(t.substr(this.col)):t.substr(this.col,e.length)==e}}),DEFINE_CLASS("Ymacs_Tokenizer",DlEventProxy,function(e,t){var n={};e.define=function(e,t){n[e.toLowerCase()]=t},e.DEFAULT_EVENTS=["onFoundToken"],e.DEFAULT_ARGS={buffer:["buffer",null],type:["type",null]},e.FIXARGS=function(e){typeof e.type=="string"&&(e.type=n[e.type.toLowerCase()])},e.CONSTRUCT=function(){var e=null,t=null;this.quickUpdate=function(n){var r=this.buffer._positionToRowCol(n).row;this.parsers.splice(r-1,this.parsers.length+1),e!=null?e=Math.min(r,e):e=r,clearTimeout(t),t=function(){this._do_quickUpdate(e),e=null}.delayed(1,this)},this._stopQuickUpdate=function(){clearTimeout(t),clearTimeout(this.timerUpdate)},this.reset()},t.reset=function(){this.stream=new Ymacs_Stream({buffer:this.buffer}),this.theParser=this.type(this.stream,this),this.parsers=[],this.parsers[-1]=this.theParser.copy(),this.timerUpdate=null,this.quickUpdate(0)},t.getLanguage=function(e,t){return n[e](this.stream,this,t)},t.showProgress=function(e){e!=null&&(e=Math.round(e/this.stream.length()*100)+"%"),this.buffer.updateProgress("Syntax highlighting",e)},t._do_quickUpdate=function(e){var t,n,r,i,s,o,u;this._stopQuickUpdate(),t=this.stream,r=this.parsers,t.line=e-1;while(!(n=r[t.line]))t.prevLine();t.nextLine(),n=n(),s=0,o=!0,u=function(){this.buffer.preventUpdates(),i=100,++s>10&&this.showProgress(this.stream.line);for(;;)try{for(;;)n.next()}catch(e){if(e!==t.EOL){if(e===t.EOF){r[t.line]=n.copy(),this.buffer.resumeUpdates(),n.on_EOF&&n.on_EOF();break}throw e}r[t.line]=n.copy(),t.nextLine();if(--i==0){this.buffer.resumeUpdates(),this.timerUpdate=setTimeout(u,25),o=!1;return}}this.showProgress()}.$(this),u()},t.quickInsertLine=function(e){this.parsers.splice(e,this.parsers.length+1)},t.quickDeleteLine=function(e){this.parsers.splice(e,this.parsers.length+1)},t.onToken=function(e,t,n,r){this.callHooks("onFoundToken",e,t,n,r)},t.getParserForLine=function(e){var t,n,r,i;this._stopQuickUpdate(),t=this.stream,r=this.parsers,i=t.line,t.line=e-1;while(!(n=r[t.line]))t.prevLine();t.nextLine(),n=n();try{this.buffer.preventUpdates();for(;;){if(t.line==e)return n;try{for(;;)n.next()}catch(s){if(s!==t.EOL){if(s===t.EOF)break;throw s}r[t.line]=n.copy(),t.nextLine()}}}finally{this.buffer.resumeUpdates(),t.line<t.length()&&(this.timerUpdate=this._do_quickUpdate.delayed(50,this,t.line))}},t.reparseAll=function(){return this.parsers.splice(0,this.parsers.length),this.finishParsing()},t.finishParsing=function(){return this.getParserForLine(this.stream.length()),this.getLastParser()},t.getLastParser=function(){return this.parsers.peek()},t.getIndentation=function(e,t){var n=this.getParserForLine(e);if(n&&n.indentation instanceof Function)return n.indentation(t)}}),DEFINE_SINGLETON("Ymacs_Keymap_ParenMatch",Ymacs_Keymap,function(e){function r(e,t){return e.line<t.line?-1:e.line>t.line?1:e.col-t.col}function i(){throw new Ymacs_Exception("Balanced expression not found")}function s(e){var t=e.context.passedParens;return t instanceof Function?t():t}var t,n;e.KEYS={"C-c \\":"goto_matching_paren","C-M-q":"indent_sexp","C-M-f && C-M-n":"forward_sexp","C-M-b && C-M-p":"backward_sexp","C-M-u && M-a && C-M-ARROW_UP":"backward_up_list","M-e":"up_list","C-M-ARROW_DOWN":"down_list","M-C-k":"kill_sexp","M-C-SPACE":"mark_sexp","M-C-t":"transpose_sexps","M-(":["paredit_wrap_round","("],"M-[":["paredit_wrap_round","["],"M-{":["paredit_wrap_round","{"],'M-"':["paredit_wrap_round",'"'],"M-'":["paredit_wrap_round","'"],"M-r":"paredit_raise_sexp","M-s":"paredit_splice_sexp",BACKSPACE:"paredit_backward_delete_char","DELETE && C-d":"paredit_delete_char"},t={"(":")","[":"]","{":"}",'"':{close:'"',backslash:/[\x22\\]/g},"'":{close:"'",backslash:/[\x27\\]/g}},n={")":"(","]":"[","}":"{",'"':'"'},Ymacs_Buffer.newCommands({matching_paren:function(){var e,t=this.tokenizer.getLastParser(),n=this._rowcol;if(t)return e=s(t),e.foreach(function(e){var t=e.closed;e.line==n.row&&e.col==n.col?$RETURN(this._rowColToPosition(t.line,t.col+1)):t.line==n.row&&t.col==n.col-1&&$RETURN(this._rowColToPosition(e.line,e.col))},this)},indent_sexp:Ymacs_Interactive(function(){var e=this.cmd("matching_paren");e!=null?this.cmd("indent_region",this.point(),e):i(this)}),goto_matching_paren:Ymacs_Interactive(function(){var e=this.cmd("matching_paren");if(e!=null)return this.cmd("goto_char",e),!0}),forward_sexp:Ymacs_Interactive(function(){var e,t,n,o=this._rowcol,u=this.tokenizer.finishParsing();if(u){e=s(u).mergeSort(r),t=e.foreach(function(e){(e.line>o.row||e.line==o.row&&e.col>=o.col)&&$RETURN(e)});if(!t||!t.closed){i(this);return}return n=this._rowColToPosition(t.line,t.col),this._rowcol.row==t.line&&this._rowcol.col==t.col||!/\S/.test(this._bufferSubstring(null,n))?this.cmd("goto_char",this._rowColToPosition(t.closed.line,t.closed.col)+1):this.cmd("goto_char",n),!0}}),backward_sexp:Ymacs_Interactive(function(){var e,t,n=this._rowcol,o=this.tokenizer.finishParsing();if(o){e=s(o).grep("closed").map("closed").mergeSort(r),t=e.r_foreach(function(e){(e.line<n.row||e.line==n.row&&e.col<n.col)&&$RETURN(e)});if(!t){i(this);return}return this.cmd("goto_char",this._rowColToPosition(t.opened.line,t.opened.col)),!0}}),mark_sexp:Ymacs_Interactive("^r",function(e,t){this.cmd("save_excursion",function(){this.transientMarker&&this.cmd("goto_char",t),this.ensureTransientMark(),this.cmd("forward_sexp"),this.cmd("set_mark_command",this.point()),this.transientMarker.swap(this.caretMarker)}),this.ensureTransientMark()}),kill_sexp:Ymacs_Interactive(function(){this._killingAction(this.point(),this.cmd("save_excursion",function(){return this.cmd("forward_sexp"),this.point()}))}),transpose_sexps:Ymacs_Interactive(function(){var e=[];this.cmd("forward_sexp"),e.push(this.point()),this.cmd("backward_sexp"),e.push(this.point()),this.cmd("backward_sexp"),e.push(this.point()),this.cmd("forward_sexp"),e.push(this.point()),this.cmd("goto_char",this._swapAreas(e))}),paredit_wrap_round:Ymacs_Interactive("^",function(e,n){var r,i,s,o,u;e||(e="("),r=t[e],i=this.transientMarker?this.getRegion():this.cmd("save_excursion",function(){var e=this.point();return n||this.cmd("forward_sexp"),{begin:e,end:this.point()}}),s=this._bufferSubstring(i.begin,i.end),o=this.point()<i.end,typeof r!="string"&&(s=s.replace(r.backslash,function(e){return"\\"+e}),r=r.close),u=this.createMarker(i.end),this.cmd("save_excursion",function(){this._replaceText(i.begin,i.end,e+s+r)},o),this.cmd("forward_char",o?1:-1),this.clearTransientMark(),this.cmd("indent_region",i.begin,u.getPosition()),u.destroy()}),down_list:Ymacs_Interactive(function(){var e,t=this._rowcol,n=this.tokenizer.finishParsing();n&&(e={line:t.row,col:t.col},n=s(n).grep("closed").mergeSort(r).grep_first(function(t){return r(t,e)>=0}),n!=null?this.cmd("goto_char",this._rowColToPosition(n.line,n.col)+1):i(this))}),backward_up_list:Ymacs_Interactive(function(){var e,t=this._rowcol,n=this.tokenizer.finishParsing();n&&(e={line:t.row,col:t.col},n=s(n).grep("closed").mergeSort(r).grep_last(function(t){return r(t,e)<0&&r(t.closed,e)>=0}),n!=null?this.cmd("goto_char",this._rowColToPosition(n.line,n.col)):i(this))
}),up_list:Ymacs_Interactive(function(){this.cmd("backward_up_list"),this.cmd("forward_sexp")}),paredit_raise_sexp:Ymacs_Interactive(function(){var e,t,n,r,i;this.cmd("forward_sexp"),this.cmd("backward_sexp"),e=this.point(),this.cmd("forward_sexp"),t=this.point(),this.cmd("backward_up_list"),n=this.point(),this.cmd("forward_sexp"),r=this.point(),i=this.cmd("buffer_substring",e,t),this._replaceText(n,r,i),this.cmd("goto_char",n),this.cmd("indent_region",n,n+i.length)}),paredit_splice_sexp:Ymacs_Interactive(function(){this.cmd("save_excursion",function(){var e,t;this.cmd("backward_up_list"),e=this.point(),this.cmd("forward_sexp"),this.cmd("backward_delete_char"),t=this.point(),this.cmd("goto_char",e),this.cmd("delete_char"),this.cmd("indent_region",e,t-1)})}),paredit_backward_delete_char:Ymacs_Interactive("^p",function(e){var n,r;if(e!=null)return this.cmd("backward_delete_char",e);this.deleteTransientRegion()||(this.cmd("looking_back",/[\(\[\{\"]/g)&&(n=t[this.matchData[0]],n&&(n.close&&(n=n.close),r=RegExp("\\s*\\"+n,"mg"),this.cmd("looking_at",r)&&this.cmd("save_excursion",function(){this.cmd("delete_whitespace"),this.cmd("delete_char")}))),this.cmd("backward_delete_char"))}),paredit_delete_char:Ymacs_Interactive("^p",function(e){var t,r;if(e!=null)return this.cmd("delete_char",e);this.deleteTransientRegion()||(this.cmd("looking_at",/[\]\}\)\"]/g)&&(t=n[this.matchData[0]],t&&(r=RegExp("\\"+t+"\\s*","mg"),this.cmd("looking_back",r)&&this.cmd("save_excursion",function(){this.cmd("backward_delete_whitespace"),this.cmd("backward_delete_char")}))),this.cmd("delete_char"))})}),Ymacs_Buffer.newMode("paren_match_mode",function(){var e,t,n,r=Ymacs_Keymap_ParenMatch();return this.pushKeymap(r),e=!1,t=function(){e&&this.deleteOverlay("match-paren")}.clearingTimeout(500,this),n={beforeInteractiveCommand:function(){t.doItNow()},afterInteractiveCommand:function(){var n=this.tokenizer.getLastParser(),r=this._rowcol;n&&s(n).foreach(function(n){var i=n.closed;if(n.line==r.row&&n.col==r.col||i.line==r.row&&i.col==r.col-1)e=!0,this.setOverlay("match-paren",{line1:n.line,line2:i.line,col1:n.col,col2:i.col+1}),t()},this)}.clearingTimeout(100)},this.addEventListener(n),function(){t.doItNow(),this.popKeymap(r),this.removeEventListener(n)}})}),function(){function f(e){this.value=e}function l(e,t){function a(){return u.peek()}function l(){return u.next()}function c(){return u.read_while(function(e){return!n&&i!=null&&u.pos==i?!1:u.is_whitespace(e)})}function h(){l()}function p(e){return u.read_while(e)}function d(e,t,n){var r,i,s;h(e),r=!1,i="";for(;;){s=l();if(!s)throw new f(i);if(r)i+=s,r=!1;else if(s=="\\")n&&(i+=s),r=!0;else{if(s==t)break;i+=s}}return i}function v(){return p(function(e){return e&&e!="\n"})}function m(){var e=p(function(){return!u.looking_at("|#")});return h(),h(),e}function g(){return d('"','"')}function y(){var e,t=r;r=0;try{e=[],h("(");e:for(;;){c();switch(a()){case")":break e;case null:throw new f(e);default:e.push(x()),++r}}return h(")"),e}finally{r=t}}function b(){var e=d("/","/",!0),t=p(function(e){if(e)switch(e.toLowerCase()){case"y":case"m":case"g":case"i":return!0}}).toLowerCase();return{pattern:e,modifiers:t}}function w(){return p(function(e){switch(e){case null:case"(":case")":case"#":case";":case"`":case"'":case'"':case"|":case" ":case"\n":case"	":case"\f":case"\u2028":case"\u2029":case" ":return!1}return!0})}function E(){return l()+p(function(e){return e>="a"&&e<="z"||e>="A"&&e<="z"||e>="0"&&e<="9"||e=="-"||e=="_"})}function S(){h("#");switch(a()){case"\\":return l(),N("char",E);case"/":return N("regexp",b);case"(":return N("vector",y);case"'":return l(),N("function",w);case"|":return l(),N("comment",m);default:return N("unknown",x)}}function x(){c();if(!n&&i!=null&&u.pos==i&&(!s||s.type=="list"))return n=N("caret");switch(a()){case";":return N("comment",v);case'"':return N("string",g);case"(":return N("list",y);case"#":return N("sharp",S);case"`":return l(),N("qq",x,-1);case",":l();if(a()=="@")return l(),N("splice",x,-2);return N("unquote",x,-1);case"'":return l(),N("quote",x,-1);case")":return null;case null:return null}return N("symbol",w)}function T(){var e,t=[];while(a()!=null){e=x();if(e==null)break;t.push(e),++r}return t}function N(e,t,n){var a,c;n==null&&(n=0),a=s;try{c={value:null,index:r,type:e,start:u.pos+n,parent:s,depth:s?s.depth+1:0,partial:!1},e=="list"&&(s=c);try{t&&(c.value=t(),c.value==""&&l())}catch(h){if(!(h instanceof f))throw h;c.value=h.value,c.partial=!0}return c.end=u.pos,i!=null&&c.start<=i&&c.end>=i&&(o||(o=c)),c}finally{s=a}}var n,r,i,s,o,u=new Ymacs_Simple_Stream({buffer:e,pos:t});return n=null,r=0,i=null,s=null,o=null,{parse:function(e){return i=e,N("list",T)},read:function(){return x()},prev_exp:function(){return n?n.parent.value[n.index-1]:o.type=="list"&&o.end==i+1?o.value.peek():o.parent.value[o.index]},caret_token:function(){return n},cont_exp:function(){return o},list:function(){var e=o;while(e&&(e.type!="list"||e.end==i))e=e.parent;return e}}}function c(e){return r[e]}function h(e){return i[e]}var e,t,n,r,i,s,o,u,a;Ymacs_Buffer.newCommands({test_lisp_parse:Ymacs_Interactive(function(){var e,t;try{e=l(this),t=e.parse(this.point()),console.log(t),console.log(e.caret_token()),console.log(e.cont_exp()),console.log(e.prev_exp())}catch(n){console.log(n)}}),lisp_make_quick_parser:function(){var e=Array.$(arguments);return e.unshift(this),l.apply(this,e)},lisp_forward_sexp:Ymacs_Interactive(function(){var e=l(this,this.point()),t=e.read();t&&this.cmd("goto_char",t.end)}),lisp_backward_sexp:Ymacs_Interactive(function(){var e,t=l(this);t.parse(this.point()),e=t.prev_exp(),e&&this.cmd("goto_char",e.start)}),lisp_backward_up_list:Ymacs_Interactive(function(){var e,t=l(this);t.parse(this.point()),e=t.list(),e&&e.parent&&this.cmd("goto_char",e.start)}),lisp_open_paren:Ymacs_Interactive(function(e){e==null&&(e="("),e+=c(e),this.cmd("insert",e),this.cmd("backward_char")}),lisp_close_paren:Ymacs_Interactive(function(e){var t=RegExp("\\s*\\"+e,"ig");this.cmd("looking_at",t)&&this._deleteText(this.point(),this.matchData.after),this.cmd("insert",e)}),lisp_close_all_parens:Ymacs_Interactive(function(){var e,t=this.tokenizer.getParserForLine(this._rowcol.row);if(t){e=this.tokenizer.stream,e.line=this._rowcol.row,e.col=0;try{while(e.col<this._rowcol.col)t.next()}catch(n){}t=t.copy().context.parens,t.r_foreach(function(e){this.cmd("lisp_close_paren",c(e.type))},this)}}),lisp_handle_string_quote:Ymacs_Interactive(function(){var e,t=l(this);t.parse(this.point()),e=t.prev_exp(),e&&e.type=="string"&&this.point()<e.end?this.cmd("looking_at",/\"/g)?this.cmd("forward_char"):this.cmd("looking_back",/\\/g)?this.cmd("insert",'"'):this.cmd("insert",'\\"'):(this.cmd("insert",'""'),this.cmd("backward_char"))})}),e="defvar defparameter deftype defstruct defclass defsetf destructuring-bind defmacro defun defmethod defgeneric defpackage in-package defreadtable in-readtable when cond unless etypecase typecase ctypecase lambda let load-time-value quote macrolet progn prog1 prog2 progv go flet the if throw eval-when multiple-value-prog1 unwind-protect let* ignore-errors handler-case handler-bind invoke-restart restart-case restart-bind case labels function symbol-macrolet block tagbody catch locally return return-from setq setf multiple-value-call".qw().toHash(),t="loop do while".qw().toHash(),n="t nil".qw().toHash(),r={"(":")","{":"}","[":"]"},i={")":"(","}":"{","]":"["},s="defun defmacro defgeneric defmethod".qw().toHash(),o="deftype defclass defstruct".qw().toHash(),u={"if":"3+",when:"1*",lambda:"1*",unless:"1*",defun:"2*",defpackage:"1*",defgeneric:"2*",defmethod:"2*",defclass:"2*",defmacro:"2*",progn:"0+",prog1:"1*",prog2:"2*",let:"1*",labels:"1*",flet:"1*",macrolet:"1*","destructuring-bind":"2*","unwind-protect":"1*","catch":"1*","case":"1*",ecase:"1*",cond:"0+","handler-bind":"1*","handler-case":"1*","restart-bind":"1*","restart-case":"1*","return-from":"1*",block:"1*",dotimes:"1*",dolist:"1*"},a="labels flet macrolet".qw().toHash(),Ymacs_Tokenizer.define("lisp",function(r,i,f){function E(e){return f.rx_special&&f.rx_special.test(e)?!1:e.toLowerCase()!=e.toUpperCase()||/^[-|0-9!#$%&*+./:<=>?@\[\]\^_\{\}~]$/i.test(e)}function S(e){return E(e)}function x(){function t(){return l=e.cont.slice(0),p=e.inString,v=e.quote,d=e.inComment,m=e.parens.slice(0),g=e.passedParens.slice(0),y=e.backList.slice(0),b=e.list.slice(0),w}var e=t.context={cont:l.slice(0),quote:v,inString:p,inComment:d,parens:m.slice(0),passedParens:g.slice(0),backList:y.slice(0),list:b.slice(0)};return t}function T(e,t,n){i.onToken(r.line,e,t,n)}function N(e){e==null&&(e={c1:r.col}),b.push(e)}function C(){return r.buffer.getq("indent_level")}function k(){var e,t=r.col,n=r.get(),i=n;while(!r.eol()){n=r.peek();if(!E(n))break;i+=n,r.nextCol()}e=n&&{line:r.line,c1:t,c2:r.col,id:i.toLowerCase()};if(e.c2>e.c1)return e}function L(e,t){var n,i=!1,s=r.col;while(!r.eol()){n=r.peek();if(n===e&&!i)return l.pop(),p=null,T(s,r.col,t),T(r.col,++r.col,t+"-stopper"),!0;i=!i&&n==="\\",r.nextCol()}T(s,r.col,t)}function A(){var e=r.lineText(),t=e.indexOf("|#",r.col),n=/^\s*\|+/.exec(e.substr(r.col));n&&T(r.col,r.col+=n[0].length,"mcomment-starter"),t<0?(T(r.col,e.length,"mcomment"),r.col=e.length):(l.pop(),d=null,T(r.col,t,"mcomment"),T(t,t+=2,"mcomment-stopper"),r.col=t)}function O(e){var t=b&&b.length>0&&b[0].id;if(t)return t=t.toLowerCase(),e==null?t:typeof e=="string"?t==e:t in e}function M(){var i,u,a,f;r.checkStop();if(l.length>0)return l.peek()();i=r.peek(),(u=r.lookingAt(/^#\\.[a-z0-9_-]*/i))?(N(),T(r.col,r.col+=u[0].length,"constant")):(u=r.lookingAt(/^#\x2f((\\.|[^\x2f])*)\x2f([igsm]*)/))?(N(),T(r.col,r.col+=2,"regexp-starter"),T(r.col,r.col+=u[1].length,"regexp"),T(r.col,r.col+=1,"regexp-stopper"),u[3]&&T(r.col,r.col+=u[3].length,"regexp-modifier")):r.lookingAt(/^#\x27[^(]/)?(N(),r.col+=2,u=k(),T(u.c1,u.c2,"function-name")):r.lookingAt("#|")?(d={line:r.line,c1:r.col},T(r.col,r.col+=2,"mcomment-starter"),l.push(A)):(u=r.lookingAt(/^;+/))?(T(r.col,r.col+=u[0].length,"comment-starter"),T(r.col,r.col=r.lineLength(),"comment")):i==='"'?(N(),p={line:r.line,c1:r.col},T(r.col,++r.col,"string-starter"),l.push(L.$C(i,"string"))):(u=r.lookingAt(/^[+-]?(#x[0-9a-f]+|#o[0-7]+|#b[01]+|[0-9]*\.?[0-9]+e?[0-9]*)(\x2f(#x[0-9a-f]+|#o[0-7]+|#b[01]+|[0-9]*\.?[0-9]+e?[0-9]*))?/))?(N(),T(r.col,r.col+=u[0].length,"number")):(u=c(i))?(N(),y.push(b),b=[],m.push({line:r.line,col:r.col,type:i}),T(r.col,++r.col,"open-paren")):(u=h(i))?(a=m.pop(),!a||a.type!=u?T(r.col,++r.col,"error"):(a.closed={line:r.line,col:r.col,opened:a},g.push(a),b=y.pop(),T(r.col,++r.col,"close-paren"))):S(i)&&(u=k())?(f=i==":"?"lisp-keyword":i=="&"?"type":/^#:/.test(u.id)?"constant":u.id in e?"keyword":u.id in t?"builtin":u.id in n?"constant":null,f||(O(s)&&b.length==1?f="function-name":O(o)&&b.length==1?f="type":/^with(out)?[-\x2f]|:with(out)?[-\x2f]/i.test(u.id)&&(f="builtin")),N(u),T(u.c1,u.c2,f)):T(r.col,++r.col,null)}function _(){var e,t,n,i,s,o,f,l,c,h,d=r.lineText();if(p)return Math.max(0,d.search(/[^\s\t\n]/));e=0,t=m.peek();if(t){n=r.lineText(t.line),e=t.col+1;if(/[\#\']/.test(n.charAt(t.col-1)))return e;S(n.charAt(e))&&(s=/\s\S/g,s.lastIndex=t.col,i=s.exec(n),i&&(e=i=i.index+1));if(b&&b.length){o=O();if(o){o=o.replace(/\*$/,""),f=u[o],!f&&/^with|:with/.test(o)&&(f="0*"),!f&&/^def/.test(o)&&(i&&/[\(\[\{]/.test(n.charAt(i))?f="1*":f="2*");if(!f)try{Object.HOP(a,y[y.length-2][0].id)&&(f="1*")}catch(v){}f&&(l=parseInt(f,10),c=/\+/.test(f),h=/\*/.test(f),e=t.col+C(),c&&i?e=i:l>0&&b.length-1<l&&(i?e=i:e+=C()))}}}return e}var l,p,d,v,m,g,y,b,w;return f||(f={}),l=[],p=!1,d=!1,v=null,m=[],g=[],y=[],b=[],w={next:M,copy:x,indentation:_},w})}(),DEFINE_SINGLETON("Ymacs_Keymap_LispMode",Ymacs_Keymap,function(e){e.KEYS={"ENTER && C-j && C-m":"newline_and_indent","(":["lisp_open_paren","("],")":["lisp_close_paren",")"],'"':["lisp_handle_string_quote"],"C-c ] && C-c C-]":"lisp_close_all_parens"}}),Ymacs_Buffer.newMode("lisp_mode",function(){var e,t,n,r,i=this.tokenizer;return this.setTokenizer(new Ymacs_Tokenizer({buffer:this,type:"lisp"})),e=this.setq({indent_level:2,syntax_comment_line:{rx:/\s*;+\s?/g,ch:";;"},syntax_word_dabbrev:{test:function(e){if(e){var t=e.charCodeAt(0);return t>=48&&t<=57||e.toUpperCase()!=e.toLowerCase()||e=="-"||e=="*"||e=="%"||e=="+"||e=="/"||e=="@"||e=="&"||e=="$"||e=="."||e=="="||e=="~"}}}}),t=Ymacs_Keymap_LispMode(),this.pushKeymap(t),n=this.cmd("paren_match_mode",!0),r=this.replaceCommands({forward_sexp:"lisp_forward_sexp",backward_sexp:"lisp_backward_sexp",backward_up_list:"lisp_backward_up_list"}),function(){this.setTokenizer(i),this.setq(e),this.newCommands(r),this.popKeymap(t),n||this.cmd("paren_match_mode",!1)}}),function(){function a(e){return e.toLowerCase()!=e.toUpperCase()}function f(e){return e&&(a(e)||/^[_$]$/.test(e))}function l(e){return e&&(a(e)||/^[0-9_$]$/.test(e))}function c(t){return e[t]}function h(e){return t[e]}function p(t,n,r,i,s,o){function y(){return s.buffer.getq("indent_level")}function b(){function t(){return a=e.cont.slice(0),v=e.inComment,m=e.inString,p=e.parens.slice(0),d=e.passedParens.slice(0),g}var e=t.context={cont:a.slice(0),inComment:v,inString:m,parens:p.slice(0),passedParens:d.slice(0)};return t}function w(e,t,n){o.onToken(s.line,e,t,n)}function E(){var e=s.col,t=s.get(),n=t;while(!s.eol()){t=s.peek();if(!l(t))break;n+=t,s.nextCol()}return t&&{line:s.line,c1:e,c2:s.col,id:n}}function S(){var e=s.lineText(),t=e.indexOf("*/",s.col),n=/^\s*\*+/.exec(e.substr(s.col));n&&w(s.col,s.col+=n[0].length,"mcomment-starter"),t<0?(w(s.col,e.length,"mcomment"),s.col=e.length):(a.pop(),v=null,w(s.col,t,"mcomment"),w(t,t+=2,"mcomment-stopper"),s.col=t)}function x(e,t){var n,r=!1,i=s.col;while(!s.eol()){n=s.peek();if(n===e&&!r)return a.pop(),m=null,w(i,s.col,t),w(s.col,++s.col,t+"-stopper"),!0;r=!r&&n==="\\",s.nextCol()}w(i,s.col,t)}function T(){var e,t,n=!1,r=0,i=s.col;while(!s.eol()){e=s.peek(),c(e)&&!n&&!r&&r++,h(e)&&!n&&(r--,r<0&&(r=0));if(e==="/"&&!n&&!r)return a.pop(),m=null,w(i,s.col,"regexp"),w(s.col,++s.col,"regexp-stopper"),t=s.lookingAt(/^[gmsiy]+/),t&&w(s.col,s.col+=t[0].length,"regexp-modifier"),!0;n=!n&&e==="\\",s.nextCol()}w(i,s.col,"regexp")}function N(){var e,o,l,g,y;s.checkStop();if(a.length>0)return a.peek()();e=s.peek(),s.lookingAt("/*")?(v={line:s.line,c1:s.col},w(s.col,s.col+=2,"mcomment-starter"),a.push(S)):s.lookingAt("//")?(w(s.col,s.col+=2,"comment-starter"),w(s.col,s.col=s.lineLength(),"comment")):e==='"'||e==="'"?(m={line:s.line,c1:s.col},w(s.col,++s.col,"string-starter"),a.push(x.$C(e,"string"))):(o=s.lookingAt(/^0x[0-9a-f]+|^[0-9]*\.?[0-9]+/))?w(s.col,s.col+=o[0].length,"number"):f(e)&&(l=E())?(g=l.id in t?"keyword":l.id in n?"type":l.id in r?"constant":l.id in i?"builtin":null,w(l.c1,l.c2,g)):(l=c(e))?(p.push({line:s.line,col:s.col,type:e}),w(s.col,++s.col,"open-paren")):(l=h(e))?(y=p.pop(),!y||y.type!=l?w(s.col,++s.col,"error"):(y.closed={line:s.line,col:s.col,opened:y},d.push(y),w(s.col,++s.col,"close-paren"))):e==="/"&&u.test(s.textBefore())?(w(s.col,++s.col,"regexp-starter"),a.push(T)):(o=s.lookingAt(/^\s+$/))?w(s.col,s.col+=o[0].length,"trailing-whitespace"):w(s.col,++s.col,null)}function C(){var t,n,r,i,o,u,a,f,l,c,h;return m?0:(t=s.line,n=s.lineText(),r=0,v?(i=s.lineText(v.line),r=v.c1+1,/^\s*\*/.test(n)||(o=/[^\s*]/g,o.lastIndex=v.c1+1,u=o.exec(i),u&&(r=u.index)),r):(a=p.peek(),a&&(o=RegExp("^\\s*\\"+e[a.type]),f=o.test(n),l=s.lineText(a.line),o=/\S/g,o.lastIndex=a.col+1,u=o.exec(l),u?r=f?a.col:u.index:(r=s.lineIndentation(a.line)+y(),f&&(r-=y()))),t>0&&(c=s.textBefore(),/\)\s*$/.test(c)&&d.length>0?(a=d.peek(),h=s.lineText(a.line),/^\s*(if|for|while)\W/.test(h)&&(r+=y())):/\Welse\s*$/.test(c)&&(r+=y())),/^\s*(case|default)\W/.test(n)&&(r-=y()/2),r))}var a=[],p=[],d=[],v=null,m=null,g={next:N,copy:b,indentation:C};return g}var e,t,n,r="abstract break case catch class const continue debugger default delete do else enum export extends final finally for function goto if implements import in instanceof interface native new package private protected public return static super switch synchronized throw throws transient try typeof var void let yield volatile while with".qw(),i="boolean byte char double float int long short void Array Date Function Math Number Object RegExp String".qw(),s="false null undefined Infinity NaN true arguments this".qw(),o="Infinity NaN Packages decodeURI decodeURIComponent encodeURI encodeURIComponent eval isFinite isNaN parseFloat parseInt undefined window document alert prototype constructor".qw(),u=/[\[({,;+\-*=?&|!:][\x20\t\n\xa0]*$|return\s+$|typeof\s+$/;e={"(":")","{":"}","[":"]"},t={")":"(","}":"{","]":"["},Ymacs_Tokenizer.define("js",p.$C(r.toHash(!0),i.toHash(!0),s.toHash(!0),o.toHash(!0))),n=o.concat("DEFINE_CLASS DEFINE_SINGLETON DEFINE_HIDDEN_CLASS DEFAULT_ARGS DEFAULT_EVENTS FIXARGS CONSTRUCT BEFORE_BASE FINISH_OBJECT_DEF D P $".qw()),Ymacs_Tokenizer.define("js-dynarchlib",p.$C(r.toHash(!0),i.toHash(!0),s.toHash(!0),n.toHash(!0)))}(),DEFINE_SINGLETON("Ymacs_Keymap_CLanguages",Ymacs_Keymap,function(e){e.KEYS={ENTER:"newline_and_indent","} && ) && ] && : && ; && { && ( && [ && *":"c_insert_and_indent"}}),Ymacs_Buffer.newMode("javascript_mode",function(e){var t,n,r=this.tokenizer,i=Ymacs_Keymap_CLanguages();return this.setTokenizer(new Ymacs_Tokenizer({buffer:this,type:e?"js-dynarchlib":"js"})),this.pushKeymap(i),t=this.cmd("paren_match_mode",!0),n=this.setq({syntax_comment_line:{rx:/\s*\x2f+\s?/g,ch:"//"}}),function(){this.setTokenizer(r),this.popKeymap(i),t||this.cmd("paren_match_mode",!1)}}),Ymacs_Buffer.newCommands({javascript_dl_mode:Ymacs_Interactive(function(){return this.cmd("javascript_mode",!0)}),c_electric_block:Ymacs_Interactive(function(){this.cmd("indent_line"),this.cmd("insert","{\n\n}"),this.cmd("indent_line"),this.cmd("backward_line",1),this.cmd("indent_line")}),c_insert_and_indent:Ymacs_Interactive(function(){var e;if(e=this.cmd("self_insert_command"))return this.cmd("indent_line"),e})}),Ymacs_Tokenizer.define("xml",function(e,t){function u(){function f(){return r=t.slice(0),n=e.slice(0),i=u,s=a,o}var e=n.slice(0),t=r.slice(0),u=i,a=s;return f}function a(){return e.buffer.getq("indent_level")}function f(n,r,i){t.onToken(e.line,n,r,i)}function l(e){return e.toLowerCase()!=e.toUpperCase()}function c(e){return e&&(l(e)||/^[:_-]$/.test(e))}function h(e){return e&&(l(e)||/^[0-9:_-]$/.test(e))}function p(){var t=e.col,n=e.get(),r=n;while(!e.eol()){n=e.peek();if(!h(n))break;r+=n,e.nextCol()}return n&&{line:e.line,c1:t,c2:e.col,id:r}}function d(t){var n,i=!1,s=e.col;while(!e.eol()){n=e.peek();if(n===t&&!i){r.pop(),f(s,e.col,"string"),f(e.col,++e.col,"string-stopper");return}i=!i&&n==="\\",e.nextCol()}f(s,e.col,"string")}function v(){var t,s=e.peek();e.lookingAt(/^\x2f>/)?(r.pop(),i=null,f(e.col,++e.col,"xml-closetag-slash"),f(e.col,++e.col,"xml-close-bracket")):s===">"?(r.pop(),n.push(i),i=null,f(e.col,++e.col,"xml-close-bracket")):c(s)&&(t=p())?f(t.c1,t.c2,"xml-attribute"):s==='"'||s==="'"?(f(e.col,++e.col,"string-starter"),r.push(d.$C(s))):f(e.col,++e.col,null)}function m(t,n){var i=e.lineText(),o=i.indexOf(n,e.col);o<0?(f(e.col,i.length,t),e.col=i.length):(r.pop(),f(e.col,o,t),s=null,f(o,o+=n.length,t+"-stopper"),e.col=o)}function g(){var t=e.lookingAt(/^([\s\xA0]*)(>?)/);t&&t[0]?(t[1]&&f(e.col,e.col+=t[1].length,null),t[2]&&(f(e.col,e.col+=t[2].length,"xml-close-bracket"),r.pop())):f(e.col,++e.col,"error")}function y(){var t,o,u,a;e.checkStop();if(r.length>0)return r.peek()();t=e.peek(),e.lookingAt("<![CDATA[")?(f(e.col,e.col+=9,"xml-cdata-starter"),s={line:e.line,c1:e.col},r.push(m.$C("xml-cdata","]]>"))):e.lookingAt("<!--")?(f(e.col,e.col+=4,"mcomment-starter"),s={line:e.line,c1:e.col},r.push(m.$C("mcomment","-->"))):e.lookingAt(/^<\x2f/)&&c(e.peek(2))?(f(e.col,++e.col,"xml-open-bracket"),f(e.col,++e.col,"xml-closetag-slash"),u=p(),a=n.pop(),f(u.c1,u.c2,a&&a.id==u.id?"xml-close-tag":"error"),r.push(g)):t==="<"&&c(e.peek(1))?(f(e.col,++e.col,"xml-open-bracket"),u=p(),f(u.c1,u.c2,"xml-open-tag"),i=u,r.push(v)):(o=e.lookingAt(/^&.*?;/))?(f(e.col,++e.col,"xml-entity-starter"),f(e.col,e.col+=o[0].length-2,"xml-entity"),f(e.col,++e.col,"xml-entity-stopper")):t==="&"?f(e.col,++e.col,"error"):f(e.col,++e.col,null)}function b(){var t,r;if(s)t=e.lineIndentation(s.line)+a();else if(i)t=i.c1+i.id.length+1;else if(r=n.peek())t=e.lineIndentation(r.line)+a(),/^\s*<\x2f/.test(e.lineText())&&(t-=a());return t}var n=[],r=[],i=null,s=null,o={next:y,copy:u,indentation:b};return o}),DEFINE_SINGLETON("Ymacs_Keymap_XML",Ymacs_Keymap,function(e){e.KEYS={"C-c /":"xml_close_tag","C-ENTER":"xml_zen_expand",ENTER:"newline_and_indent"}}),Ymacs_Buffer.newMode("xml_mode",function(){var e,t,n=this.tokenizer;return this.setTokenizer(new Ymacs_Tokenizer({buffer:this,type:"xml"})),e=Ymacs_Keymap_XML(),this.pushKeymap(e),t=this.setq({indent_level:2}),function(){this.setTokenizer(n),this.popKeymap(e),this.setq(t)}}),function(){function s(e,t){var n,r=e.repeat||1;for(n=1;n<=r;++n)n>1&&t("\n"),t("<",e.type),e.id&&t(' id="',e.id.replace(/\$/g,n),'"'),e.klass&&t(' class="',e.klass.replace(/\$/g,n),'"'),e.attributes&&e.attributes.foreach(function(e){t(" ",e,'="|"')}),t(">"),e.child?(t("\n"),s(e.child,t),t("\n")):t("|"),t("</",e.type,">"),e.next&&(t("\n"),s(e.next,t))}function o(s,u){var a,f={type:""},l=e;e:while(u<s.length){a=s.charAt(u++);switch(a){case"#":l=n,f.id="";break;case".":l=t,f.klass!=null?f.klass+=" ":f.klass="";break;case":":l=i,f.attributes==null&&(f.attributes=[]),f.attributes.push("");break;case"*":l=r,f.repeat="";break;case">":f.child=o(s,u),u=f.child.i;break e;case"(":f.child=o(s,u),u=f.child.i;break;case")":break e;case"+":f.next=o(s,u),u=f.next.i;break e;default:switch(l){case e:f.type+=a;break;case t:f.klass+=a;break;case n:f.id+=a;break;case r:f.repeat=parseInt(f.repeat+""+a,10);break;case i:f.attributes.push(f.attributes.pop()+a)}}}return f.i=u,f}function u(){var e=this.point(),t=this.getq("xml_zen_markers"),n=t[0],r=t.peek();(e<n.getPosition()||e>r.getPosition()||r.getPosition()==t.peek(1).getPosition())&&this.cmd("xml_zen_stop")}var e,t,n,r,i;DEFINE_SINGLETON("Ymacs_Keymap_XML_Zen",Ymacs_Keymap,function(e){e.KEYS={TAB:"xml_zen_next_poi","S-TAB":"xml_zen_prev_poi","C-g":"xml_zen_stop"}}),e=1,t=2,n=3,r=4,i=5,Ymacs_Buffer.newCommands({xml_close_tag:Ymacs_Interactive(function(){this.cmd("close_last_xml_tag"),this.cmd("indent_line")}),xml_zen_expand:Ymacs_Interactive(function(){var e,t,n,r,i,a;this.cmd("xml_zen_stop"),e=String.buffer(),t=this.cmd("save_excursion",function(){this.cmd("backward_whitespace");while(!this.cmd("looking_back",/[\x20\xa0\s\t\n;&]/))if(!this.cmd("backward_char"))break;return this.point()}),n=this.point();try{s(o(this.cmd("buffer_substring",t,n).trim(),0),e)}catch(f){throw new Ymacs_Exception("The Zen is not strong today :-/")}e=e.get(),this.cmd("delete_region",t,n),this.cmd("insert",e),t=this.createMarker(t,!1,"xml_zen"),r=this.createMarker(this.point(),!0,"xml_zen"),i=[],this.cmd("goto_char",t.getPosition());while(this.cmd("search_forward","|",r.getPosition()))this.cmd("backward_delete_char"),i.push(this.createMarker(this.point(),!0,"xml_zen_start")),i.push(this.createMarker(this.point(),!1,"xml_zen_end"));this.cmd("indent_region",t.getPosition(),r.getPosition()),a=i.length,a>0?(this.cmd("goto_char",i[0]),i.unshift(t),i.push(r),this.setq("xml_zen_markers",i),this.pushKeymap(Ymacs_Keymap_XML_Zen()),this.addEventListener("afterInteractiveCommand",u)):(t.destroy(),r.destroy())}),xml_zen_stop:Ymacs_Interactive(function(){var e=this.getq("xml_zen_markers");e&&(e.map("destroy"),this.setq("xml_zen_markers",null)),this.popKeymap(Ymacs_Keymap_XML_Zen()),this.removeEventListener("afterInteractiveCommand",u)}),xml_zen_next_poi:Ymacs_Interactive(function(){var e=this.getq("xml_zen_markers"),t=this.point();e.foreach(function(e){e.getPosition()>t&&(this.cmd("goto_char",e.getPosition()),$BREAK())},this)}),xml_zen_prev_poi:Ymacs_Interactive(function(){var e=this.getq("xml_zen_markers"),t=this.point();e.r_foreach(function(e){e.getPosition()<t&&(this.cmd("goto_char",e.getPosition()),$BREAK())},this)})})}(),Ymacs_Tokenizer.define("css",function(e,t){function l(){function t(){return s=e.parens.slice(0),o=e.passedParens.slice(0),u=e.cont.slice(0),a=e.inString,f=e.inComment,i}var e=t.context={parens:s.slice(0),passedParens:o.slice(0),cont:u.slice(0),inString:a,inComment:f};return t}function c(){return t.buffer.getq("indent_level")}function h(e){return n[e]}function p(e){return r[e]}function d(n,r,i){t.onToken(e.line,n,r,i)}function v(){var t=e.lineText(),n=t.indexOf("*/",e.col),r=/^\s*\*+/.exec(t.substr(e.col));r&&d(e.col,e.col+=r[0].length,"mcomment-starter"),n<0?(d(e.col,t.length,"mcomment"),e.col=t.length):(u.pop(),f=null,d(e.col,n,"mcomment"),d(n,n+=2,"mcomment-stopper"),e.col=n)}function m(t,n){var r,i=!1,s=e.col;while(!e.eol()){r=e.peek();if(r===t&&!i)return u.pop(),a=null,d(s,e.col,n),d(e.col,++e.col,n+"-stopper"),!0;i=!i&&r==="\\",e.nextCol()}d(s,e.col,n)}function g(){var t,n,r;e.checkStop();if(u.length>0)return u.peek()();t=e.peek(),e.lookingAt("/*")?(f={line:e.line,c1:e.col},d(e.col,e.col+=2,"mcomment-starter"),u.push(v)):t==='"'||t==="'"?(a={line:e.line,c1:e.col},d(e.col,++e.col,"string-starter"),u.push(m.$C(t,"string"))):(n=h(t))?(s.push({line:e.line,col:e.col,type:t}),d(e.col,++e.col,"open-paren")):(n=p(t))?(r=s.pop(),!r||r.type!=n?d(e.col,++e.col,"error"):(r.closed={line:e.line,col:e.col,opened:r},o.push(r),d(e.col,++e.col,"close-paren"))):(n=e.lookingAt(/^([a-zA-z-]+):/))?(d(e.col,e.col+=n[1].length,"keyword"),d(e.col,++e.col,"operator")):(n=e.lookingAt(/^([0-9.]+)(px|pt|em|ex|in|cm|mm|%)/))?(d(e.col,e.col+=n[1].length,"number"),d(e.col,e.col+=n[2].length,"type")):(n=e.lookingAt(/^(\.[a-zA-Z0-9_:-]+)/))?d(e.col,e.col+=n[1].length,"function-name"):(n=e.lookingAt(/^(#[a-zA-Z0-9_:-]+)/))?d(e.col,e.col+=n[1].length,"constant"):(n=e.lookingAt(/^(@[a-zA-Z0-9_:-]+)/))?d(e.col,e.col+=n[1].length,"builtin"):(n=e.lookingAt(/^(url|none|auto|bold|italic|normal|inherit|print|screen|all)/))?d(e.col,e.col+=n[1].length,"builtin"):d(e.col,++e.col,null)}function y(){var t,r,i,o,u,l,h,p,d;return a?0:(t=e.line,r=e.lineText(),i=0,f?(o=e.lineText(f.line),i=f.c1+1,/^\s*\*/.test(r)||(u=/[^\s*]/g,u.lastIndex=f.c1+1,l=u.exec(o),l&&(i=l.index)),i):(h=s.peek(),h&&(u=RegExp("^\\s*\\"+n[h.type]),p=u.test(r),d=e.lineText(h.line),u=/\S/g,u.lastIndex=h.col+1,l=u.exec(d),l?i=p?h.col:l.index:(i=e.lineIndentation(h.line)+c(),p&&(i-=c()))),i))}var n,r,i={next:g,copy:l,indentation:y},s=[],o=[],u=[],a=null,f=null;return n={"(":")","{":"}","[":"]"},r={")":"(","}":"{","]":"["},i}),DEFINE_SINGLETON("Ymacs_Keymap_CSS",Ymacs_Keymap),Ymacs_Keymap_CSS().defineKeys({ENTER:"newline_and_indent",": && } && )":"c_insert_and_indent"}),Ymacs_Buffer.newMode("css_mode",function(){var e,t=this.tokenizer;return this.setTokenizer(new Ymacs_Tokenizer({buffer:this,type:"css"})),e=this.cmd("paren_match_mode",!0),this.pushKeymap(Ymacs_Keymap_CSS()),function(){this.setTokenizer(t),e||this.cmd("paren_match_mode",!1),this.popKeymap(Ymacs_Keymap_CSS())}}),Ymacs_Tokenizer.define("markdown",function(e,t){function r(){function t(){return n}var e=t.context={};return t}function i(n,r,i){t.onToken(e.line,n,r,i)}function s(){var n;e.checkStop(),e.col==0&&(n=e.lookingAt(/^(#+)/))?i(0,e.col=e.lineLength(),"markdown-heading"+n[0].length):e.line>0&&e.col==0&&(n=e.lookingAt(/^[=-]+$/))&&/\S/.test(e.lineText(e.line-1))?(n=n[0].charAt(0)=="="?1:2,n="markdown-heading"+n,t.onToken(e.line-1,0,e.lineLength(e.line-1),n),i(0,e.col=e.lineLength(),n)):e.col==0&&(n=e.lookingAt(/^[>\s]*/))?(n=n[0].replace(/\s+/g,"").length,n>3&&(n=""),n="markdown-blockquote"+n,i(0,e.col=e.lineLength(),n)):i(e.col,++e.col,null)}var n={next:s,copy:r};return n}),Ymacs_Buffer.newMode("markdown_mode",function(){var e=this.tokenizer;return this.setTokenizer(new Ymacs_Tokenizer({buffer:this,type:"markdown"})),function(){this.setTokenizer(e)}});